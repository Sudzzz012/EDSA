<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register Staff User | Erase Debt SA</title>
  <link rel="icon" href="erase-debt-logo.png"/>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg,#003865,#005c97); 
      margin:0; padding:24px; color:#14243b; 
    }
    .wrap { 
      max-width: 860px; 
      margin: 0 auto; 
    }
    .header { 
      display:flex; 
      align-items:center; 
      gap:16px; 
      margin-bottom:14px; 
    }
    .logo { 
      width:110px; 
      border-radius:12px; 
      box-shadow:0 6px 24px #2970ba55; 
    }
    .title { 
      color:#fff; 
      font-size:1.9rem; 
      font-weight:800; 
      letter-spacing:-.2px; 
    }
    .card { 
      background:#fff; 
      border-radius:16px; 
      box-shadow:0 14px 44px #2970ba33; 
      padding:22px; 
    }
    .desc { 
      color:#445; 
      text-align:center; 
      margin:6px 0 18px;
      background: #e7f3ff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #2970ba;
    }
    label { 
      display:block; 
      font-weight:700; 
      margin:10px 0 6px; 
      color: #2970ba;
    }
    input, select { 
      width:100%; 
      padding:12px; 
      border-radius:10px; 
      border:2px solid #c7d8ef; 
      font-size:1rem; 
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2970ba;
      box-shadow: 0 0 0 3px rgba(41, 112, 186, 0.1);
    }
    .row { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:14px; 
    }
    @media(max-width:780px){ 
      .row { 
        grid-template-columns:1fr; 
      } 
    }
    button { 
      width:100%; 
      margin-top:16px; 
      padding:14px; 
      border:none; 
      border-radius:12px; 
      background:#2970ba; 
      color:#fff; 
      font-weight:800; 
      cursor:pointer; 
      transition: background 0.3s;
      font-size: 1.1rem;
    }
    button:hover { 
      background:#003865; 
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .success {
      color: #16a34a;
    }
    .error {
      color: #dc2626;
    }
    .strength-weak { color: #dc2626; }
    .strength-medium { color: #f59e0b; }
    .strength-strong { color: #16a34a; }
    .msg { 
      margin-top:14px; 
      font-weight:700; 
      text-align:center; 
      white-space:pre-wrap; 
    }
    .success {
      color: #16a34a;
    }
    .error {
      color: #dc2626;
    }
    .strength-weak { color: #dc2626; }
    .strength-medium { color: #f59e0b; }
    .strength-strong { color: #16a34a; }
    .back { 
      display:inline-block; 
      margin-top:14px; 
      color:#2970ba; 
      font-weight:700; 
      text-decoration:none; 
    }
    .back:hover {
      text-decoration: underline;
    }
    .small { 
      font-size: 0.92rem; 
      color:#5b6b82; 
      margin-top: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <img src="erase-debt-logo.png" alt="Erase Debt SA" class="logo"/>
      <div class="title">Erase Debt SA ‚Ä¢ Staff Registration</div>
    </div>

    <div class="card">
      <div class="desc">
        <strong>üÜï Create New Staff User Account</strong><br>
        Enter all details below. The ID Number will be used as the username for login.
      </div>

      <form id="registerForm" autocomplete="off">
        <div class="row">
          <div>
            <label>Full Name *</label>
            <input id="full_name" required placeholder="John Doe" />
          </div>
          <div>
            <label>Email Address *</label>
            <input id="email" type="email" required placeholder="john@erasedebtsa.co.za" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>ID Number (Username) *</label>
            <input id="id_number" required placeholder="1234567890123" maxlength="13" />
          </div>
          <div>
            <label>Role *</label>
            <select id="role" required>
              <option value="">Select Role</option>
              <option value="agent">Agent</option>
              <option value="admin">Admin</option>
              <option value="admin_manager">Admin Manager</option>
              <option value="super">Super User</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Branch *</label>
            <select id="branch" required>
              <option value="">Select Branch</option>
              <option>Erase Debt SA - ADMIN</option>
              <option>Erase Debt SA - MP</option>
              <option>Erase Debt SA - SS</option>
              <option>Clean Slate Solutions - MSJ</option>
              <option>Clean Slate Solutions - RSJ</option>
              <option>Boost My Credit Score</option>
              <option>Fix My Credit Score</option>
              <option>Credit Boost SA</option>
              <option>Credit Renew SA</option>
              <option>National Credit Solutions</option>
              <option>Get Credit SA</option>
              <option>Shield Credit Solutions</option>
              <option>SAZZ Debt Solutions</option>
              <option>Clean Credit Consultants</option>
              <option>SA Blacklisting Busters</option>
              <option>Increase My Credit Score</option>
              <option>South African Credit Score Experts - AA</option>
              <option>South African Credit Score Experts - QAA</option>
              <option>Credifix SA</option>
            </select>
          </div>
          <div>
            <label>Status *</label>
            <select id="status" required>
              <option value="active" selected>Active</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Password *</label>
            <input id="password" type="password" required placeholder="Enter secure password (min 6 chars)" autocomplete="new-password" />
          </div>
          <div>
            <label>Confirm Password *</label>
            <input id="confirm_password" type="password" required placeholder="Confirm password" autocomplete="new-password" />
          </div>
        </div>
        
        <div id="passwordStrengthNew" class="small" style="color: #666;">Enter password to see strength indicator</div>

        <button type="submit" id="submitBtn">Create User</button>
        <div id="msg" class="msg"></div>
        <div class="small">‚úÖ User will be able to login immediately with their ID number and password.</div>
      </form>

      <a class="back" href="super_dashboard.html">‚Üê Back to Super Dashboard</a>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://xzjunkpxvfdpuogoflzh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ'
    );

    const msg = document.getElementById('msg');
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');

    function setStatus(text, type = 'info') {
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    // Minimal validation
    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Auto-format ID number (numbers only, max 13 digits)
    document.getElementById('id_number').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 13) value = value.substring(0, 13);
      e.target.value = value;
    });

    // Check password strength for new user creation
    function checkPasswordStrengthNew(password) {
      const strengthEl = document.getElementById('passwordStrengthNew');
      
      if (password.length < 6) {
        strengthEl.textContent = '‚ùå Too short (minimum 6 characters)';
        strengthEl.className = 'small strength-weak';
        return false;
      } else if (password.length < 8) {
        strengthEl.textContent = '‚ö†Ô∏è Medium strength (consider longer password)';
        strengthEl.className = 'small strength-medium';
        return true;
      } else {
        strengthEl.textContent = '‚úÖ Strong password';
        strengthEl.className = 'small strength-strong';
        return true;
      }
    }

    // Real-time password strength checking
    document.getElementById('password').addEventListener('input', function(e) {
      checkPasswordStrengthNew(e.target.value);
    });

    // Simple password hashing (for demo - in production use proper bcrypt)
    async function hashPassword(password) {
      // Simple hash for demo - in production you'd use proper bcrypt server-side
      return btoa(password + 'salt_edsa_2025');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('‚è≥ Creating user...', 'info');
      submitBtn.disabled = true;

      const full_name = document.getElementById('full_name').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const id_number = document.getElementById('id_number').value.trim();
      const password = document.getElementById('password').value.trim();
      const confirm_password = document.getElementById('confirm_password').value.trim();
      const role = document.getElementById('role').value;
      const branch = document.getElementById('branch').value;
      const status = document.getElementById('status').value;

      // Validation
      if (!validateEmail(email)) { 
        setStatus('‚ùå Please enter a valid email.', 'error'); 
        submitBtn.disabled = false;
        return; 
      }
      if (!/^[0-9]{13}$/.test(id_number)) { 
        setStatus('‚ùå Please enter a valid 13-digit ID number.', 'error'); 
        submitBtn.disabled = false;
        return; 
      }
      if (password.length < 6) {
        setStatus('‚ùå Password must be at least 6 characters.', 'error');
        submitBtn.disabled = false;
        return;
      }
      if (password !== confirm_password) {
        setStatus('‚ùå Passwords do not match.', 'error');
        submitBtn.disabled = false;
        return;
      }
      if (!role) { 
        setStatus('‚ùå Please select a role.', 'error'); 
        submitBtn.disabled = false;
        return; 
      }
      if (!branch) { 
        setStatus('‚ùå Please select a branch.', 'error'); 
        submitBtn.disabled = false;
        return; 
      }

      try {
        // Hash the password
        const password_hash = await hashPassword(password);

        // Insert into edsa_users
        const userData = {
          id: crypto.randomUUID(),
          full_name,
          email,
          id_number,
          password_hash,
          role,
          branch,
          status,
          is_active: status === 'active',
          created_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('edsa_users')
          .insert([userData]);

        if (error) {
          throw error;
        }

        setStatus('üéâ User created successfully!', 'success');
        form.reset();
        
      } catch (err) {
        console.error('Error creating user:', err);
        setStatus('‚ùå Error: ' + (err?.message || String(err)), 'error');
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Session management
    (function(){
      try {
        const sess = JSON.parse(localStorage.getItem('edsa_staff_session') || 'null');
        if (!sess) { 
          window.location.href = 'staff-login.html'; 
          return; 
        }
      } catch(e) {
        console.error(e);
        window.location.href = 'staff-login.html';
      }
    })();
  </script>
</body>
</html>