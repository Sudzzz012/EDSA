<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Track Your Application & Queries ‚Äî Secure Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="erase-debt-logo.png"/>
  <style>
    :root{
      --bg1:#004080; --bg2:#0073e6; --panel:#ffffff; --text:#003f7f; --brand:#005cbf;
      --brand-2:#3385ff; --muted:#c9d7ff; --chip:#e6f0ff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    * { box-sizing: border-box; }
    
    /* Login Form Styles */
    body { 
      font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: #0c1f3b; color: #fff; margin: 0; min-height: 100vh;
    }
    .login-wrap { 
      max-width: 520px; margin: 40px auto; padding: 24px; 
      background: #122a52; border-radius: 16px; 
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .logo { display: block; margin: 0 auto 20px; width: 80px; }
    h1 { margin: 0 0 12px; font-size: 24px; text-align: center; color: #fff; }
    p.sub { margin: 0 0 24px; color: #c9d7ff; text-align: center; }
    label { display: block; margin: 12px 0 6px; color: #fff; }
    input { 
      width: 100%; padding: 12px 14px; border-radius: 12px; 
      border: 1px solid #2e4b87; background: #0f2142; color: #fff; outline: none;
    }
    input::placeholder { color: #a8b4d7; }
    button { 
      margin-top: 16px; width: 100%; padding: 12px 16px; border: 0; 
      border-radius: 12px; background: #3b82f6; color: #fff; 
      font-weight: 700; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .notice { 
      margin-top: 12px; padding: 10px; border-radius: 10px; 
      background: #1e3a8a; color: #dbeafe; display: none;
    }
    .error { background: #991b1b; color: #fecaca; }
    .success { background: #166534; color: #bbf7d0; }
    .hidden { display: none; }
    .back { 
      display: inline-block; margin-top: 16px; color: #c9d7ff; 
      text-decoration: none; text-align: center;
    }
    .info { background: #1e3a8a; color: #dbeafe; border-left: 4px solid #3b82f6; }

    /* Dashboard Styles */
    .dashboard { color: #fff; min-height: 100vh; }
    .header { 
      background-color: #002f5f; padding: 18px 20px; display: flex; 
      gap: 16px; align-items: center; justify-content: center; flex-wrap: wrap;
    }
    .header img { height: 58px; border-radius: 12px; }
    .header h1 { margin: 0; font-size: 26px; letter-spacing: .3px; }
    .header .ref {
      margin-left: auto; margin-right: auto; background: rgba(255,255,255,.1);
      padding: 8px 12px; border-radius: 10px; color: #dfe9ff; font-size: 14px;
    }
    
    .container { 
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; 
      padding: 24px; max-width: 1400px; margin: 0 auto;
    }
    @media (max-width: 900px) { 
      .container { grid-template-columns: 1fr; } 
    }
    
    .section {
      background: var(--panel); color: var(--text); border-radius: 14px; 
      padding: 20px; box-shadow: 0 6px 22px rgba(0,0,0,.15);
    }
    .section h3 { 
      margin: 0 0 16px; display: flex; align-items: center; gap: 10px; 
      color: var(--brand); font-size: 18px;
    }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #e9eef7; text-align: left; font-size: 14px; }
    th { background-color: var(--chip); font-weight: bold; }
    
    .chip { 
      display: inline-block; padding: 4px 8px; border-radius: 999px; 
      font-size: 12px; background: var(--chip); color: var(--text); 
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .dot-ok { background: var(--ok); } 
    .dot-warn { background: var(--warn); } 
    .dot-bad { background: var(--bad); }
    
    .feedback-section { margin-top: 20px; }
    textarea, input[type="file"] {
      width: 100%; padding: 10px; margin-top: 10px; border-radius: 10px; 
      border: 1px solid #cfd9ee; font-size: 15px;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; margin-top: 10px;
      padding: 12px 16px; background: var(--brand); color: #fff; 
      text-decoration: none; border-radius: 10px; font-weight: 600; 
      border: 0; cursor: pointer; transition: .25s;
    }
    .btn:hover { background: var(--brand-2); }
    
    .topbar { 
      display: flex; justify-content: center; padding: 8px 20px; 
      background: rgba(0,0,0,.2);
    }
    .topbar a { color: #dbe7ff; text-decoration: none; margin: 0 8px; font-size: 13px; }
    .muted { color: #5b78a5; font-size: 13px; }
  </style>
</head>
<body>
  <!-- Login Flow -->
  <div id="loginFlow">
    <div class="login-wrap">
      <img src="erase-debt-logo.png" alt="Erase Debt SA" class="logo"/>
      <h1>Track Your Application</h1>
      <p class="sub">Enter your ID & email. We'll send you a secure magic link to access your application and query history.</p>

      <div id="step1">
        <label>South African ID Number</label>
        <input id="idn" placeholder="e.g. 8804015196086" inputmode="numeric" autocomplete="off"/>

        <label>Email Address</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>

        <button id="sendBtn">Send Secure Login Link</button>
        <div id="msg1" class="notice"></div>
      </div>

      <div id="step2" class="hidden">
        <div class="notice info" style="display:block">
          üìß <strong>Check your email!</strong><br>
          We've sent you a secure login link. Click it to access your application tracking and query history.
        </div>
        <button onclick="goBackToStep1()" style="background:#666; margin-top:10px;">‚Üê Try Different Email</button>
      </div>

      <div style="text-align:center;">
        <a class="back" href="index.html">‚Üê Back</a>
      </div>
    </div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboardView" class="hidden dashboard">
    <header class="header">
      <img src="erase-debt-logo.png" alt="Erase Debt SA">
      <h1>Your Application & Query Status</h1>
      <div id="refChip" class="ref">Ref: ‚Äî</div>
    </header>

    <div class="topbar">
      <a href="index.html">‚Üê Back to Homepage</a> | 
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="container">
      <!-- Application Status Section (Primary) -->
      <div class="section">
        <h3><i class="fa-solid fa-file-contract"></i> Application Status <span id="statusChip" class="chip"></span></h3>
        <table>
          <tbody id="appTable">
            <tr><th>Client Name</th><td id="clientName">‚Äî</td></tr>
            <tr><th>Service Type</th><td id="serviceType">‚Äî</td></tr>
            <tr><th>Status</th><td id="appStatus">‚Äî</td></tr>
            <tr><th>Branch</th><td id="branch">‚Äî</td></tr>
            <tr><th>Payments Made</th><td id="paymentsMade">‚Äî</td></tr>
            <tr><th>Missed Payments</th><td id="missedPayments">‚Äî</td></tr>
            <tr><th>Remaining Payments</th><td id="remainingPayments">‚Äî</td></tr>
            <tr><th>Monthly Payment</th><td id="monthlyPayment">‚Äî</td></tr>
            <tr><th>Outstanding Balance</th><td id="outstanding">‚Äî</td></tr>
            <tr><th>Next Payment Date</th><td id="nextPayment">‚Äî</td></tr>
          </tbody>
        </table>
        <div class="muted" id="policyNote"></div>

        <div class="feedback-section">
          <h4>Submit Document / Payment Update</h4>
          <textarea id="appFeedbackText" rows="3" placeholder="Type your update, payment confirmation, or question..."></textarea>
          <div class="row">
            <input id="fileInput" type="file" />
            <button id="submitAppFeedback" class="btn">
              <i class="fa-solid fa-upload"></i> Submit
            </button>
          </div>
          <div id="appMsg" class="notice"></div>
        </div>
      </div>

      <!-- Query Communication Section -->
      <div class="section">
        <h3><i class="fa-regular fa-comments"></i> Query & Communication History</h3>
        <table>
          <thead>
            <tr><th>Date</th><th>Type</th><th>Message</th><th>Admin Reply</th><th>Status</th></tr>
          </thead>
          <tbody id="queryHistory">
            <tr><td colspan="5" class="muted">Loading...</td></tr>
          </tbody>
        </table>

        <div class="feedback-section">
          <h4>Send New Query / Message</h4>
          <textarea id="queryText" rows="3" placeholder="Type your question or message to admin team..."></textarea>
          <button id="submitQuery" class="btn">
            <i class="fa-solid fa-paper-plane"></i> Send Query
          </button>
          <div id="queryMsg" class="notice"></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://xzjunkpxvfdpuogoflzh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentClient = null;
let allQueries = [];

function show(el, text, type = 'info') {
  el.style.display = "block";
  el.className = "notice " + type;
  el.textContent = text;
}

function hide(el) {
  el.style.display = "none";
  el.textContent = "";
}

function goBackToStep1() {
  document.getElementById('step1').classList.remove('hidden');
  document.getElementById('step2').classList.add('hidden');
  hide(document.getElementById('msg1'));
  document.getElementById('idn').value = '';
  document.getElementById('email').value = '';
}

function logout() {
  client.auth.signOut();
  document.getElementById('loginFlow').classList.remove('hidden');
  document.getElementById('dashboardView').classList.add('hidden');
}

function fmtDate(d) {
  try { return new Date(d).toLocaleString(); } catch { return d || "‚Äî"; }
}

function na(x) { 
  return (x === null || x === undefined || x === "") ? "‚Äî" : x; 
}

// Load application data
async function loadApplicationData(idNumber, email) {
  const { data, error } = await client
    .from('edsa_client_database')
    .select('*')
    .eq('client_id_number', idNumber)
    .eq('email', email)
    .maybeSingle();

  return error ? null : data;
}

// Load all queries for this client
async function loadAllQueries(idNumber, email) {
  const { data, error } = await client
    .from('QUERIES')
    .select('*')
    .eq('id_number', idNumber)
    .eq('email', email)
    .order('created_at', { ascending: false });

  return error ? [] : (data || []);
}

// Display application data
function displayApplicationData(appData) {
  if (!appData) {
    document.getElementById('appTable').innerHTML = '<tr><td colspan="2" class="muted">No application found</td></tr>';
    document.getElementById('policyNote').textContent = 'No application data available.';
    return;
  }

  const fullName = [appData.first_name, appData.last_name].filter(Boolean).join(' ');
  const made = parseInt(appData.total_no_payments_made || 0, 10);
  const missed = parseInt(appData.total_no_missed_payments || 0, 10);
  const totalPlan = parseInt(appData.payment_plan_months || 0, 10);
  const remaining = Math.max(0, totalPlan - made);
  const monthly = parseFloat(appData.monthly_payment || 0);
  const outstanding = Math.max(0, Math.round((remaining * monthly + Number.EPSILON) * 100) / 100);

  document.getElementById('clientName').textContent = na(fullName);
  document.getElementById('serviceType').textContent = na(appData.service_type);
  document.getElementById('appStatus').textContent = na(appData.status);
  document.getElementById('branch').textContent = na(appData.branch_name);
  document.getElementById('paymentsMade').textContent = made;
  document.getElementById('missedPayments').textContent = missed;
  document.getElementById('remainingPayments').textContent = remaining;
  document.getElementById('monthlyPayment').textContent = monthly ? `R${monthly.toLocaleString()}` : "‚Äî";
  document.getElementById('outstanding').textContent = monthly ? `R${outstanding.toLocaleString()}` : "‚Äî";
  document.getElementById('nextPayment').textContent = na(appData.salary_date || appData.tracking_date);

  const chip = document.getElementById('statusChip');
  chip.textContent = na(appData.status || 'PENDING').toUpperCase();

  // Set reference
  document.getElementById('refChip').textContent = `Ref: ${appData.sale_reference || 'N/A'}`;
}

// Display query history
function displayQueryHistory(queries) {
  const historyBody = document.getElementById('queryHistory');
  
  if (!queries || queries.length === 0) {
    historyBody.innerHTML = '<tr><td colspan="5" class="muted">No queries yet</td></tr>';
    return;
  }

  const rows = queries.map(q => {
    const status = (q.status || 'PENDING').toUpperCase();
    const dotClass = status.includes('RESOLVED') ? 'dot-ok' : 
                    status.includes('PENDING') ? 'dot-warn' : 'dot-bad';
    return `<tr>
      <td>${fmtDate(q.created_at)}</td>
      <td>${q.query_type || 'GENERAL'}</td>
      <td>${q.query_text || q.client_message || '‚Äî'}</td>
      <td>${q.response_text || q.admin_reply || 'Pending response'}</td>
      <td><span class="status-dot ${dotClass}"></span> ${status}</td>
    </tr>`;
  }).join('');
  historyBody.innerHTML = rows;
}

// Submit application feedback
async function submitAppFeedback() {
  const msgEl = document.getElementById('appMsg');
  hide(msgEl);
  const text = document.getElementById('appFeedbackText').value.trim();
  const file = document.getElementById('fileInput').files[0];

  if (!text && !file) {
    return show(msgEl, 'Please enter a message or attach a file.', 'error');
  }

  if (!currentClient) {
    return show(msgEl, 'No application found.', 'error');
  }

  let fileUrl = null;
  if (file) {
    const path = `${currentClient.sale_reference}/${Date.now()}_${file.name}`;
    const { data: up, error: upErr } = await client.storage
      .from('edsa-queries').upload(path, file, { upsert: false });
    
    if (upErr) {
      console.error(upErr);
      return show(msgEl, 'Upload failed. Please try again.', 'error');
    }
    
    const { data: pub } = client.storage.from('edsa-queries').getPublicUrl(path);
    fileUrl = pub?.publicUrl || null;
  }

  // Insert as new query
  const payload = {
    reference_number: currentClient.sale_reference,
    id_number: currentClient.client_id_number,
    email: currentClient.email,
    first_name: currentClient.first_name,
    last_name: currentClient.last_name,
    query_type: 'APPLICATION_UPDATE',
    query_text: text,
    attachment_url: fileUrl,
    status: 'PENDING'
  };

  const { error } = await client.from('QUERIES').insert(payload);
  if (error) {
    console.error(error);
    return show(msgEl, 'Could not submit. Please try again.', 'error');
  }

  show(msgEl, 'Submitted successfully! Admin team will respond shortly.', 'success');
  document.getElementById('appFeedbackText').value = '';
  document.getElementById('fileInput').value = '';
  
  // Refresh query history
  allQueries = await loadAllQueries(currentClient.client_id_number, currentClient.email);
  displayQueryHistory(allQueries);
}

// Submit new query
async function submitNewQuery() {
  const msgEl = document.getElementById('queryMsg');
  hide(msgEl);
  const text = document.getElementById('queryText').value.trim();

  if (!text) {
    return show(msgEl, 'Please enter a message.', 'error');
  }

  if (!currentClient) {
    return show(msgEl, 'No client data found.', 'error');
  }

  const payload = {
    reference_number: currentClient.sale_reference,
    id_number: currentClient.client_id_number,
    email: currentClient.email,
    first_name: currentClient.first_name,
    last_name: currentClient.last_name,
    query_type: 'GENERAL',
    query_text: text,
    status: 'PENDING'
  };

  const { error } = await client.from('QUERIES').insert(payload);
  if (error) {
    console.error(error);
    return show(msgEl, 'Could not submit query. Please try again.', 'error');
  }

  show(msgEl, 'Query submitted successfully!', 'success');
  document.getElementById('queryText').value = '';
  
  // Refresh query history
  allQueries = await loadAllQueries(currentClient.client_id_number, currentClient.email);
  displayQueryHistory(allQueries);
}

// Format ID number input
document.getElementById('idn').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length > 13) value = value.substring(0, 13);
  e.target.value = value;
});

// Handle magic link authentication
client.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session) {
    console.log('User signed in via magic link:', session.user.email);
    
    // Get client data from user metadata
    const userData = session.user.user_metadata || {};
    const clientName = userData.client_name || '';
    const reference = userData.reference || '';
    
    // Load client data from database
    const { data: clientData } = await client
      .from('edsa_client_database')
      .select('*')
      .eq('email', session.user.email)
      .maybeSingle();
    
    if (clientData) {
      currentClient = clientData;
      allQueries = await loadAllQueries(clientData.client_id_number, clientData.email);
      
      displayApplicationData(clientData);
      displayQueryHistory(allQueries);
      
      document.getElementById('loginFlow').classList.add('hidden');
      document.getElementById('dashboardView').classList.remove('hidden');
    }
  }
});

// Send magic link
document.getElementById('sendBtn').addEventListener("click", async () => {
  const msg1 = document.getElementById('msg1');
  hide(msg1);
  
  const idn = document.getElementById("idn").value.trim();
  const email = document.getElementById("email").value.trim().toLowerCase();

  // Validation
  if (!idn || !email) {
    return show(msg1, "Please fill in both ID number and email address.", 'error');
  }
  
  if (!/^[0-9]{13}$/.test(idn)) {
    return show(msg1, "Please enter a valid 13-digit South African ID number.", 'error');
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return show(msg1, "Please enter a valid email address.", 'error');
  }

  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true;
  sendBtn.textContent = "Checking...";
  
  try {
    // Check if client exists in database
    const { data: clientData, error: clientError } = await client
      .from('edsa_client_database')
      .select('sale_reference, first_name, last_name')
      .eq('client_id_number', idn)
      .eq('email', email)
      .maybeSingle();

    if (clientError) {
      throw new Error('Database error: ' + clientError.message);
    }

    if (!clientData) {
      return show(msg1, 'No client found with this ID number and email combination.', 'error');
    }

    sendBtn.textContent = "Sending link...";

    // Send magic link
    const redirectUrl = `${window.location.origin}/track-application.html`;
    
    const { error: magicLinkError } = await client.auth.signInWithOtp({
      email: email,
      options: {
        emailRedirectTo: redirectUrl,
        data: {
          client_name: `${clientData.first_name} ${clientData.last_name}`,
          reference: clientData.sale_reference,
          id_number: idn
        }
      }
    });

    if (magicLinkError) {
      throw new Error('Failed to send magic link: ' + magicLinkError.message);
    }

    show(msg1, '‚úÖ Secure login link sent to your email!', 'success');
    
    setTimeout(() => {
      document.getElementById('step1').classList.add("hidden");
      document.getElementById('step2').classList.remove("hidden");
    }, 1500);
    
  } catch(error) {
    console.error('Error:', error);
    show(msg1, error.message || "Failed to process request. Please try again.", 'error');
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "Send Secure Login Link";
  }
});

// Event listeners for feedback
document.getElementById('submitAppFeedback').addEventListener('click', submitAppFeedback);
document.getElementById('submitQuery').addEventListener('click', submitNewQuery);

console.log('üöÄ Track Application page loaded (Unified View)');
</script>
</body>
</html>