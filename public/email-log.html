<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email & SMS Logs - Erase Debt SA</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #003865, #005c97);
      color: #fff;
    }
    .header {
      background-color: #002f5f;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header img {
      height: 60px;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
    }
    .back-button {
      background: #2970ba;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
    }
    .container {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      color: #dce8f7;
      font-size: 0.9rem;
    }
    .filters {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      margin-bottom: 5px;
      font-weight: bold;
    }
    .filter-group select,
    .filter-group input {
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }
    .email-table {
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #2970ba;
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: bold;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      color: #333;
    }
    tr:nth-child(even) {
      background: #f8fafc;
    }
    tr:hover {
      background: #e6f3ff;
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-sent {
      background: #d1fae5;
      color: #065f46;
    }
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .status-failed {
      background: #fecaca;
      color: #991b1b;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #333;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="header">
    <img src="erase-debt-logo.png" alt="Erase Debt SA Logo" />
    <h1>Email & SMS Logs</h1>
    <a href="javascript:history.back()" class="back-button">
      <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <div class="container">
    <!-- Statistics Cards -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalEmails">-</div>
        <div class="stat-label">Total Sent</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="sentEmails">-</div>
        <div class="stat-label">Successful</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="failedEmails">-</div>
        <div class="stat-label">Failed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayEmails">-</div>
        <div class="stat-label">Today</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Type</label>
        <select id="typeFilter">
          <option value="">All Types</option>
          <option value="EMAIL">Email</option>
          <option value="SMS">SMS</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select id="statusFilter">
          <option value="">All Statuses</option>
          <option value="SENT">Sent</option>
          <option value="PENDING">Pending</option>
          <option value="FAILED">Failed</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Search</label>
        <input type="text" id="searchInput" placeholder="Search by recipient..." />
      </div>
      <div class="filter-group">
        <label>Date</label>
        <input type="date" id="dateFilter" />
      </div>
    </div>

    <!-- Email Logs Table -->
    <div class="email-table">
      <table>
        <thead>
          <tr>
            <th>Date/Time</th>
            <th>Recipient</th>
            <th>Type</th>
            <th>Subject/Message</th>
            <th>Status</th>
            <th>Agent</th>
          </tr>
        </thead>
        <tbody id="emailTableBody">
          <tr>
            <td colspan="6" class="loading">
              <i class="fa-solid fa-spinner fa-spin"></i> Loading email logs...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Sample email log data (replace with real data from database)
    const sampleEmails = [
      {
        id: 1,
        date: new Date().toISOString(),
        recipient_name: 'John Doe',
        recipient_email: 'john@example.com',
        type: 'EMAIL',
        subject: 'Welcome to Erase Debt SA',
        status: 'SENT',
        agent: 'System Auto'
      },
      {
        id: 2,
        date: new Date(Date.now() - 3600000).toISOString(),
        recipient_name: 'Jane Smith',
        recipient_email: 'jane@example.com',
        type: 'SMS',
        subject: 'Payment reminder',
        status: 'SENT',
        agent: 'Admin Team'
      },
      {
        id: 3,
        date: new Date(Date.now() - 7200000).toISOString(),
        recipient_name: 'Bob Johnson',
        recipient_email: 'bob@example.com',
        type: 'EMAIL',
        subject: 'Application status update',
        status: 'FAILED',
        agent: 'Agent Smith'
      }
    ];

    let allEmails = [...sampleEmails];
    let filteredEmails = [...allEmails];

    // Load email logs
    async function loadEmailLogs() {
      try {
        // In production, load from database:
        // const { data, error } = await supabaseClient
        //   .from('email_logs')
        //   .select('*')
        //   .order('created_at', { ascending: false });

        updateStats();
        displayEmailLogs();
      } catch (error) {
        console.error('Error loading email logs:', error);
        document.getElementById('emailTableBody').innerHTML = `
          <tr><td colspan="6" style="color: red; text-align: center;">
            Error loading email logs: ${error.message}
          </td></tr>
        `;
      }
    }

    // Update statistics
    function updateStats() {
      const total = allEmails.length;
      const sent = allEmails.filter(e => e.status === 'SENT').length;
      const failed = allEmails.filter(e => e.status === 'FAILED').length;
      const today = allEmails.filter(e => {
        const emailDate = new Date(e.date).toDateString();
        const todayDate = new Date().toDateString();
        return emailDate === todayDate;
      }).length;

      document.getElementById('totalEmails').textContent = total;
      document.getElementById('sentEmails').textContent = sent;
      document.getElementById('failedEmails').textContent = failed;
      document.getElementById('todayEmails').textContent = today;
    }

    // Display email logs
    function displayEmailLogs() {
      const tbody = document.getElementById('emailTableBody');
      
      if (filteredEmails.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No email logs found</td></tr>';
        return;
      }

      tbody.innerHTML = filteredEmails.map(email => {
        const statusClass = `status-${email.status.toLowerCase()}`;
        
        return `
          <tr>
            <td>${new Date(email.date).toLocaleString()}</td>
            <td>
              ${email.recipient_name}<br>
              <small>${email.recipient_email}</small>
            </td>
            <td>${email.type}</td>
            <td>${email.subject}</td>
            <td><span class="status-badge ${statusClass}">${email.status}</span></td>
            <td>${email.agent}</td>
          </tr>
        `;
      }).join('');
    }

    // Filter emails
    function filterEmails() {
      const typeFilter = document.getElementById('typeFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const dateFilter = document.getElementById('dateFilter').value;

      filteredEmails = allEmails.filter(email => {
        if (typeFilter && email.type !== typeFilter) return false;
        if (statusFilter && email.status !== statusFilter) return false;
        
        if (searchTerm) {
          const searchableText = [
            email.recipient_name,
            email.recipient_email,
            email.subject
          ].join(' ').toLowerCase();
          
          if (!searchableText.includes(searchTerm)) return false;
        }
        
        if (dateFilter) {
          const emailDate = new Date(email.date).toDateString();
          const filterDate = new Date(dateFilter).toDateString();
          if (emailDate !== filterDate) return false;
        }
        
        return true;
      });

      displayEmailLogs();
    }

    // Event listeners for filters
    document.getElementById('typeFilter').addEventListener('change', filterEmails);
    document.getElementById('statusFilter').addEventListener('change', filterEmails);
    document.getElementById('searchInput').addEventListener('input', filterEmails);
    document.getElementById('dateFilter').addEventListener('change', filterEmails);

    // Load email logs on page load
    document.addEventListener('DOMContentLoaded', loadEmailLogs);

    // Session management
    (function(){
      try {
        const sess = JSON.parse(localStorage.getItem('edsa_staff_session') || 'null');
        if (!sess) { 
          window.location.href = 'staff-login.html'; 
          return; 
        }
      } catch(e) {
        console.error(e);
        window.location.href = 'staff-login.html';
      }
    })();
  </script>
</body>
</html>