<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Manager - Erase Debt SA</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #003865, #005c97);
      color: #fff;
    }
    .header {
      background-color: #002f5f;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header img {
      height: 60px;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
    }
    .back-button {
      background: #2970ba;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
    }
    .container {
      padding: 30px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .quick-actions {
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      text-align: center;
    }
    .quick-actions h2 {
      margin-bottom: 20px;
      color: #fff;
    }
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .action-card {
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    .action-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #2970ba;
    }
    .action-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #003865;
      margin-bottom: 10px;
    }
    .action-desc {
      color: #64748b;
      line-height: 1.5;
    }
    .password-form {
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      border-radius: 15px;
      padding: 30px;
      margin-top: 30px;
      display: none;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #2970ba;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8f0;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2970ba;
      box-shadow: 0 0 0 3px rgba(41, 112, 186, 0.1);
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
    }
    .btn-primary {
      background: #2970ba;
      color: white;
    }
    .btn-success {
      background: #16a34a;
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      display: none;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    .error {
      background: #fecaca;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    .password-strength {
      margin-top: 5px;
      font-size: 12px;
    }
    .strength-weak { color: #dc2626; }
    .strength-medium { color: #f59e0b; }
    .strength-strong { color: #16a34a; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="header">
    <img src="erase-debt-logo.png" alt="Erase Debt SA Logo" />
    <h1>Password Manager</h1>
    <a href="super_dashboard.html" class="back-button">
      <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <div class="container">
    <!-- Quick Actions -->
    <div class="quick-actions">
      <h2><i class="fa-solid fa-key"></i> Password Management</h2>
      <p>Manage user passwords and account security for all staff members.</p>
      
      <div class="action-grid">
        <div class="action-card" onclick="showCreateUser()">
          <div class="action-icon">
            <i class="fa-solid fa-user-plus"></i>
          </div>
          <div class="action-title">Create New User</div>
          <div class="action-desc">Add a new staff member with username and password</div>
        </div>
        
        <div class="action-card" onclick="showChangePassword()">
          <div class="action-icon">
            <i class="fa-solid fa-key"></i>
          </div>
          <div class="action-title">Change Password</div>
          <div class="action-desc">Update password for existing staff members</div>
        </div>
        
        <div class="action-card" onclick="location.href='user-management.html'">
          <div class="action-icon">
            <i class="fa-solid fa-users-cog"></i>
          </div>
          <div class="action-title">Manage Users</div>
          <div class="action-desc">View, edit, and manage all user accounts</div>
        </div>
        
        <div class="action-card" onclick="showBulkReset()">
          <div class="action-icon">
            <i class="fa-solid fa-shield-alt"></i>
          </div>
          <div class="action-title">Security Tools</div>
          <div class="action-desc">Bulk password reset and security management</div>
        </div>
      </div>
    </div>

    <!-- Change Password Form -->
    <div id="changePasswordForm" class="password-form">
      <h2><i class="fa-solid fa-key"></i> Change User Password</h2>
      
      <form id="passwordChangeForm">
        <div class="form-row">
          <div class="form-group">
            <label>Select User *</label>
            <select id="userSelect" required>
              <option value="">-- Select User --</option>
            </select>
          </div>
          <div class="form-group">
            <label>Current Role</label>
            <input type="text" id="currentRole" readonly style="background: #f8fafc;" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" id="newPasswordBulk" required placeholder="Enter new password" />
            <div id="passwordStrengthBulk" class="password-strength"></div>
          </div>
          <div class="form-group">
            <label>Confirm Password *</label>
            <input type="password" id="confirmPasswordBulk" required placeholder="Confirm new password" />
          </div>
        </div>
        
        <div style="text-align: center;">
          <button type="submit" class="btn btn-primary" id="updatePasswordBtn">
            <i class="fa-solid fa-save"></i> Update Password
          </button>
          <button type="button" class="btn btn-secondary" onclick="hideAllForms()">
            <i class="fa-solid fa-times"></i> Cancel
          </button>
        </div>
        
        <div id="passwordMessage" class="message"></div>
      </form>
    </div>

    <!-- Create User Form -->
    <div id="createUserForm" class="password-form">
      <h2><i class="fa-solid fa-user-plus"></i> Create New User</h2>
      
      <form id="userCreationForm">
        <div class="form-row">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="newUserName" required placeholder="John Doe" />
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="newUserEmail" required placeholder="john@erasedebtsa.co.za" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>ID Number (Username) *</label>
            <input type="text" id="newUserIdNumber" required placeholder="1234567890123" maxlength="13" />
          </div>
          <div class="form-group">
            <label>Role *</label>
            <select id="newUserRole" required>
              <option value="">Select Role</option>
              <option value="agent">Agent</option>
              <option value="admin">Admin</option>
              <option value="admin_manager">Admin Manager</option>
              <option value="super">Super User</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Branch *</label>
            <select id="newUserBranch" required>
              <option value="">Select Branch</option>
              <option>Erase Debt SA - ADMIN</option>
              <option>Erase Debt SA - MP</option>
              <option>Erase Debt SA - SS</option>
              <option>SAZZ Debt Solutions</option>
              <option>Credifix SA</option>
              <option>SA Blacklisting Busters</option>
              <option>Get Credit SA</option>
              <option>Boost My Credit Score</option>
              <option>Shield Credit Solutions</option>
              <option>National Credit Solutions</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select id="newUserStatus" required>
              <option value="active" selected>Active</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Password *</label>
            <input type="password" id="newUserPassword" required placeholder="Enter password" />
            <div id="newPasswordStrength" class="password-strength"></div>
          </div>
          <div class="form-group">
            <label>Confirm Password *</label>
            <input type="password" id="newUserConfirmPassword" required placeholder="Confirm password" />
          </div>
        </div>
        
        <div style="text-align: center;">
          <button type="submit" class="btn btn-success" id="createUserBtn">
            <i class="fa-solid fa-user-plus"></i> Create User
          </button>
          <button type="button" class="btn btn-secondary" onclick="hideAllForms()">
            <i class="fa-solid fa-times"></i> Cancel
          </button>
        </div>
        
        <div id="createMessage" class="message"></div>
      </form>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://xzjunkpxvfdpuogoflzh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ'
    );

    let allUsers = [];

    // Load all users
    async function loadUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('edsa_users')
          .select('*')
          .order('full_name', { ascending: true });

        if (error) throw error;

        allUsers = data || [];
        populateUserSelect();
      } catch (error) {
        console.error('Error loading users:', error);
        showMessage('createMessage', 'Error loading users: ' + error.message, 'error');
      }
    }

    // Populate user select dropdown
    function populateUserSelect() {
      const select = document.getElementById('userSelect');
      select.innerHTML = '<option value="">-- Select User --</option>';
      
      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.full_name} (${user.role}) - ${user.email}`;
        select.appendChild(option);
      });
    }

    // Show forms
    function showCreateUser() {
      hideAllForms();
      document.getElementById('createUserForm').style.display = 'block';
    }

    function showChangePassword() {
      hideAllForms();
      document.getElementById('changePasswordForm').style.display = 'block';
      loadUsers();
    }

    function showBulkReset() {
      alert('🔐 Bulk Password Reset\n\nThis feature would:\n• Reset all user passwords\n• Send new passwords via email\n• Force password change on next login\n\nContact system administrator to implement this feature.');
    }

    function hideAllForms() {
      document.getElementById('createUserForm').style.display = 'none';
      document.getElementById('changePasswordForm').style.display = 'none';
    }

    // Update role display when user is selected
    document.getElementById('userSelect').addEventListener('change', function(e) {
      const userId = e.target.value;
      const user = allUsers.find(u => u.id === userId);
      document.getElementById('currentRole').value = user ? 
        `${user.role.replace('_', ' ').toUpperCase()} - ${user.branch}` : '';
    });

    // Password strength checking
    function checkPasswordStrength(password, strengthElementId) {
      const strengthEl = document.getElementById(strengthElementId);
      
      if (password.length < 6) {
        strengthEl.textContent = '❌ Too short (minimum 6 characters)';
        strengthEl.className = 'password-strength strength-weak';
        return false;
      } else if (password.length < 8) {
        strengthEl.textContent = '⚠️ Medium strength';
        strengthEl.className = 'password-strength strength-medium';
        return true;
      } else {
        strengthEl.textContent = '✅ Strong password';
        strengthEl.className = 'password-strength strength-strong';
        return true;
      }
    }

    // Password strength event listeners
    document.getElementById('newPasswordBulk').addEventListener('input', function(e) {
      checkPasswordStrength(e.target.value, 'passwordStrengthBulk');
    });

    document.getElementById('newUserPassword').addEventListener('input', function(e) {
      checkPasswordStrength(e.target.value, 'newPasswordStrength');
    });

    // Auto-format ID number
    document.getElementById('newUserIdNumber').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 13) value = value.substring(0, 13);
      e.target.value = value;
    });

    // Simple password hashing
    async function hashPassword(password) {
      return btoa(password + 'salt_edsa_2025');
    }

    // Show message
    function showMessage(elementId, text, type = 'success') {
      const msgEl = document.getElementById(elementId);
      msgEl.textContent = text;
      msgEl.className = `message ${type}`;
      msgEl.style.display = 'block';
    }

    // Hide message
    function hideMessage(elementId) {
      document.getElementById(elementId).style.display = 'none';
    }

    // Handle password change form
    document.getElementById('passwordChangeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const userId = document.getElementById('userSelect').value;
      const newPassword = document.getElementById('newPasswordBulk').value;
      const confirmPassword = document.getElementById('confirmPasswordBulk').value;
      const updateBtn = document.getElementById('updatePasswordBtn');
      
      hideMessage('passwordMessage');
      
      if (!userId) {
        showMessage('passwordMessage', '❌ Please select a user.', 'error');
        return;
      }
      
      if (!checkPasswordStrength(newPassword, 'passwordStrengthBulk')) {
        showMessage('passwordMessage', '❌ Password is too weak.', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showMessage('passwordMessage', '❌ Passwords do not match.', 'error');
        return;
      }
      
      updateBtn.disabled = true;
      updateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';
      
      try {
        const passwordHash = await hashPassword(newPassword);
        const user = allUsers.find(u => u.id === userId);
        
        const { error } = await supabaseClient
          .from('edsa_users')
          .update({ 
            password_hash: passwordHash,
            updated_at: new Date().toISOString()
          })
          .eq('id', userId);

        if (error) throw error;

        showMessage('passwordMessage', `✅ Password updated successfully for ${user.full_name}!`, 'success');
        document.getElementById('passwordChangeForm').reset();
        document.getElementById('currentRole').value = '';
        
      } catch (error) {
        console.error('Error updating password:', error);
        showMessage('passwordMessage', '❌ Failed to update password: ' + error.message, 'error');
      } finally {
        updateBtn.disabled = false;
        updateBtn.innerHTML = '<i class="fa-solid fa-save"></i> Update Password';
      }
    });

    // Handle user creation form
    document.getElementById('userCreationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const createBtn = document.getElementById('createUserBtn');
      hideMessage('createMessage');
      
      const formData = {
        full_name: document.getElementById('newUserName').value.trim(),
        email: document.getElementById('newUserEmail').value.trim().toLowerCase(),
        id_number: document.getElementById('newUserIdNumber').value.trim(),
        role: document.getElementById('newUserRole').value,
        branch: document.getElementById('newUserBranch').value,
        status: document.getElementById('newUserStatus').value,
        password: document.getElementById('newUserPassword').value,
        confirmPassword: document.getElementById('newUserConfirmPassword').value
      };
      
      // Validation
      if (!formData.full_name || !formData.email || !formData.id_number || !formData.role || !formData.branch) {
        showMessage('createMessage', '❌ Please fill in all required fields.', 'error');
        return;
      }
      
      if (!/^[0-9]{13}$/.test(formData.id_number)) {
        showMessage('createMessage', '❌ ID number must be exactly 13 digits.', 'error');
        return;
      }
      
      if (!checkPasswordStrength(formData.password, 'newPasswordStrength')) {
        showMessage('createMessage', '❌ Password is too weak.', 'error');
        return;
      }
      
      if (formData.password !== formData.confirmPassword) {
        showMessage('createMessage', '❌ Passwords do not match.', 'error');
        return;
      }
      
      createBtn.disabled = true;
      createBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';
      
      try {
        const passwordHash = await hashPassword(formData.password);
        
        const userData = {
          id: crypto.randomUUID(),
          full_name: formData.full_name,
          email: formData.email,
          id_number: formData.id_number,
          password_hash: passwordHash,
          role: formData.role,
          branch: formData.branch,
          status: formData.status,
          is_active: formData.status === 'active',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('edsa_users')
          .insert([userData]);

        if (error) throw error;

        showMessage('createMessage', `✅ User created successfully! Username: ${formData.id_number}`, 'success');
        document.getElementById('userCreationForm').reset();
        document.getElementById('newPasswordStrength').textContent = '';
        loadUsers(); // Refresh user list
        
      } catch (error) {
        console.error('Error creating user:', error);
        showMessage('createMessage', '❌ Error creating user: ' + error.message, 'error');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Create User';
      }
    });

    // Load users on page load
    document.addEventListener('DOMContentLoaded', loadUsers);

    // Session management
    (function(){
      try {
        const sess = JSON.parse(localStorage.getItem('edsa_staff_session') || 'null');
        if (!sess || sess.role !== 'super') { 
          alert('Access denied. Super User privileges required.');
          window.location.href = 'staff-login.html'; 
          return; 
        }
      } catch(e) {
        console.error(e);
        window.location.href = 'staff-login.html';
      }
    })();
  </script>
</body>
</html>