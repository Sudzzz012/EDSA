<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deployment Status Checker - Erase Debt SA</title>
  <link rel="icon" href="erase-debt-logo.png"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #003865, #005c97);
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      color: #333;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .logo {
      width: 100px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
      color: #2970ba;
      margin-bottom: 30px;
    }
    .check-item {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      background: #f8fafc;
      border-left: 5px solid #ccc;
    }
    .check-item.checking {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    .check-item.success {
      background: #d4edda;
      border-left-color: #28a745;
    }
    .check-item.error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    .check-icon {
      font-size: 20px;
      margin-right: 15px;
      min-width: 25px;
    }
    .check-content {
      flex: 1;
    }
    .check-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .check-desc {
      font-size: 14px;
      color: #666;
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .action-buttons {
      text-align: center;
      margin-top: 30px;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      margin: 10px;
      background: #2970ba;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background: #1e5a8a;
    }
    .btn.success {
      background: #28a745;
    }
    .btn.warning {
      background: #ffc107;
      color: #333;
    }
    .instructions {
      background: #e7f3ff;
      border: 1px solid #2970ba;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .instructions h3 {
      color: #2970ba;
      margin-top: 0;
    }
    .code-block {
      background: #f1f3f4;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      font-family: monospace;
      margin: 10px 0;
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 20px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <script>
    // SUPER USER ONLY ACCESS
    (function(){
      try {
        const sess = JSON.parse(localStorage.getItem('edsa_staff_session') || 'null');
        if (!sess || sess.role !== 'super') { 
          alert('‚ùå ACCESS DENIED\n\nDeployment Status is restricted to Super Users only.\n\nPlease login as Super User to access this feature.');
          window.location.href = 'staff-login.html'; 
          return; 
        }
      } catch(e) {
        console.error(e);
        alert('‚ùå Authentication required. Please login first.');
        window.location.href = 'staff-login.html';
      }
    })();
  </script>

  <div class="container">
    <img src="erase-debt-logo.png" alt="Erase Debt SA" class="logo"/>
    <h1>üöÄ Deployment Status Checker</h1>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
    </div>
    
    <div id="checksList">
      <!-- Dynamic checks will be inserted here -->
    </div>

    <div class="instructions" id="instructions" style="display: none;">
      <h3>üìã Next Steps:</h3>
      <div id="instructionContent"></div>
    </div>

    <div class="action-buttons">
      <button class="btn" onclick="runAllChecks()">üîÑ Check Everything</button>
      <button class="btn" onclick="testDeploy()" id="deployBtn" style="display: none;">üöÄ Test Deploy</button>
      <button class="btn success" onclick="openGitHub()" id="githubBtn" style="display: none;">üìÅ Open GitHub Repo</button>
      <a href="index.html" class="btn">‚Üê Back to Home</a>
    </div>
  </div>

  <script>
    let checks = [
      {
        id: 'env-file',
        title: 'Environment Configuration',
        desc: 'Check if .env file exists with GitHub settings',
        status: 'pending'
      },
      {
        id: 'build-files',
        title: 'Build System',
        desc: 'Verify build.js and package.json are ready',
        status: 'pending'
      },
      {
        id: 'github-setup',
        title: 'GitHub Connection',
        desc: 'Test connection to GitHub repository',
        status: 'pending'
      },
      {
        id: 'deploy-script',
        title: 'Deployment Scripts',
        desc: 'Verify deployment automation is working',
        status: 'pending'
      },
      {
        id: 'file-sync',
        title: 'File Synchronization',
        desc: 'Check if files can be synced to GitHub',
        status: 'pending'
      }
    ];

    let currentStep = 0;
    let githubRepo = '';

    function updateProgress() {
      const completed = checks.filter(c => c.status === 'success').length;
      const percentage = (completed / checks.length) * 100;
      document.getElementById('progressBar').style.width = percentage + '%';
    }

    function renderChecks() {
      const container = document.getElementById('checksList');
      container.innerHTML = checks.map(check => {
        let iconClass = '‚è≥';
        let statusClass = 'checking';
        
        if (check.status === 'success') {
          iconClass = '‚úÖ';
          statusClass = 'success';
        } else if (check.status === 'error') {
          iconClass = '‚ùå';
          statusClass = 'error';
        } else if (check.status === 'checking') {
          iconClass = '‚è≥';
          statusClass = 'checking';
        }

        return `
          <div class="check-item ${statusClass}" id="check-${check.id}">
            <div class="check-icon ${check.status === 'checking' ? 'spinner' : ''}">${iconClass}</div>
            <div class="check-content">
              <div class="check-title">${check.title}</div>
              <div class="check-desc">${check.desc}</div>
            </div>
          </div>
        `;
      }).join('');
      
      updateProgress();
    }

    function updateCheck(id, status, desc) {
      const check = checks.find(c => c.id === id);
      if (check) {
        check.status = status;
        if (desc) check.desc = desc;
        renderChecks();
      }
    }

    function showInstructions(title, content) {
      document.getElementById('instructions').style.display = 'block';
      document.getElementById('instructionContent').innerHTML = `
        <h4>${title}</h4>
        ${content}
      `;
    }

    async function runAllChecks() {
      console.log('üîç Starting deployment checks...');
      
      // Reset all checks
      checks.forEach(check => check.status = 'checking');
      renderChecks();
      
      // Check 1: Environment file
      setTimeout(() => {
        updateCheck('env-file', 'checking', 'Looking for .env configuration...');
        
        // Simulate check - in real scenario this would check for .env file
        const hasEnvExample = true; // We created .env.example
        
        if (hasEnvExample) {
          updateCheck('env-file', 'success', '‚úÖ Found .env.example template - ready for setup');
          checkBuildSystem();
        } else {
          updateCheck('env-file', 'error', '‚ùå Missing environment configuration');
          showEnvInstructions();
        }
      }, 500);
    }

    function checkBuildSystem() {
      setTimeout(() => {
        updateCheck('build-files', 'checking', 'Verifying build system...');
        
        // Check if build system is ready
        const hasBuildScript = true; // We have build.js
        const hasPackageJson = true; // We have package.json
        
        if (hasBuildScript && hasPackageJson) {
          updateCheck('build-files', 'success', '‚úÖ Build system ready (build.js + package.json)');
          checkGitHubSetup();
        } else {
          updateCheck('build-files', 'error', '‚ùå Missing build scripts');
        }
      }, 1000);
    }

    function checkGitHubSetup() {
      setTimeout(() => {
        updateCheck('github-setup', 'checking', 'Testing GitHub connection...');
        
        // Check if setup wizard files exist
        const hasSetupScript = true; // We created setup-github.js
        
        if (hasSetupScript) {
          updateCheck('github-setup', 'success', '‚úÖ Setup wizard ready - run "npm run setup-github"');
          checkDeployScripts();
        } else {
          updateCheck('github-setup', 'error', '‚ùå GitHub setup missing');
        }
      }, 1500);
    }

    function checkDeployScripts() {
      setTimeout(() => {
        updateCheck('deploy-script', 'checking', 'Verifying deployment automation...');
        
        const hasDeployScript = true; // We created deploy-to-github.js
        const hasWorkflow = true; // We created GitHub Actions workflow
        
        if (hasDeployScript && hasWorkflow) {
          updateCheck('deploy-script', 'success', '‚úÖ Deployment automation ready');
          checkFileSync();
        } else {
          updateCheck('deploy-script', 'error', '‚ùå Deployment scripts missing');
        }
      }, 2000);
    }

    function checkFileSync() {
      setTimeout(() => {
        updateCheck('file-sync', 'checking', 'Ready for file synchronization...');
        
        // Final check
        updateCheck('file-sync', 'success', '‚úÖ Ready to sync files to GitHub');
        
        // Show completion
        showCompletionInstructions();
        document.getElementById('deployBtn').style.display = 'inline-block';
        
      }, 2500);
    }

    function showEnvInstructions() {
      showInstructions('üîß Environment Setup Required', `
        <p><strong>You need to set up GitHub credentials:</strong></p>
        <div class="code-block">npm run setup-github</div>
        <p>This will walk you through:</p>
        <ul>
          <li>‚úÖ Creating GitHub repository</li>
          <li>‚úÖ Getting Personal Access Token</li>
          <li>‚úÖ Configuring automatic deployment</li>
        </ul>
      `);
    }

    function showCompletionInstructions() {
      showInstructions('üéâ System Ready for Deployment!', `
        <p><strong>Your deployment system is configured and ready!</strong></p>
        
        <h4>üîß First-Time Setup (One time only):</h4>
        <div class="code-block">npm run setup-github</div>
        <p>Follow the prompts to enter your GitHub repository and token.</p>
        
        <h4>üöÄ Deploy Your Files:</h4>
        <div class="code-block">npm run deploy</div>
        <p>This will automatically build and upload all your HTML files to GitHub.</p>
        
        <h4>üîÑ Automatic Updates:</h4>
        <div class="code-block">npm run webhook</div>
        <p>Starts a server that can automatically deploy when files change.</p>
        
        <p><strong>Need help with GitHub setup?</strong> <br>
           Click the "üÜò Help Me Setup GitHub" button below!</p>
      `);
    }

    function testDeploy() {
      if (confirm('üöÄ Test deployment?\n\nThis will:\n‚Ä¢ Build your project\n‚Ä¢ Upload files to GitHub\n‚Ä¢ Show you the results\n\nContinue?')) {
        alert('üß™ Test deployment would run:\n\n1. npm run build\n2. git add .\n3. git commit\n4. git push to GitHub\n\nRun "npm run deploy" in your terminal to try it!');
      }
    }

    function openGitHub() {
      const repo = prompt('üìÅ Enter your GitHub repository URL or username/repo-name:');
      if (repo) {
        const url = repo.includes('github.com') ? repo : `https://github.com/${repo}`;
        window.open(url, '_blank');
      }
    }

    // Initialize
    renderChecks();
    
    // Auto-start checks
    setTimeout(() => {
      runAllChecks();
    }, 1000);
  </script>
</body>
</html>