<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Track Your Application ‚Äî Secure Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="erase-debt-logo.png"/>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0c1f3b;color:#fff;margin:0}
    .wrap{max-width:520px;margin:40px auto;padding:24px;background:#122a52;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .logo{display:block;margin:0 auto 20px;width:80px}
    h1{margin:0 0 12px;font-size:24px;text-align:center;color:#fff}
    p.sub{margin:0 0 24px;color:#c9d7ff;text-align:center}
    label{display:block;margin:12px 0 6px;color:#fff}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2e4b87;background:#0f2142;color:#fff;outline:none}
    input::placeholder{color:#a8b4d7}
    button{margin-top:16px;width:100%;padding:12px 16px;border:0;border-radius:12px;background:#3b82f6;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .notice{margin-top:12px;padding:10px;border-radius:10px;background:#0b1a33;color:#cfe0ff;display:none}
    .error{background:#331016;color:#ffd3d8}
    .success{background:#0d4a1f;color:#c3f0ca}
    .hidden{display:none}
    .back{display:inline-block;margin-top:16px;color:#c9d7ff;text-decoration:none;text-align:center}
    .info{background:#1e3a8a;color:#dbeafe;border-left:4px solid #3b82f6}
  </style>
</head>
<body>
  <div class="wrap">
    <img src="erase-debt-logo.png" alt="Erase Debt SA" class="logo"/>
    <h1>Track Your Application</h1>
    <p class="sub">Enter your ID & email. We'll send you a secure magic link to access your application.</p>

    <div id="step1">
      <label>South African ID Number</label>
      <input id="idn" placeholder="e.g. 8804015196086" inputmode="numeric" autocomplete="off"/>

      <label>Email Address</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>

      <button id="sendBtn">Send Secure Login Link</button>
      <div id="msg1" class="notice"></div>
    </div>

    <div id="step2" class="hidden">
      <div class="notice info" style="display:block">
        üìß <strong>Check your email!</strong><br>
        We've sent you a secure login link. Click it to access your application tracking.
      </div>
      <button onclick="goBackToStep1()" style="background:#666; margin-top:10px;">‚Üê Try Different Email</button>
    </div>

    <div style="text-align:center;">
      <a class="back" href="index.html">‚Üê Back</a>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://xzjunkpxvfdpuogoflzh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const sendBtn = document.getElementById("sendBtn");
const msg1 = document.getElementById("msg1");
const step1 = document.getElementById("step1");
const step2 = document.getElementById("step2");

function show(el, text, type = 'info') {
  el.style.display = "block";
  el.className = "notice " + type;
  el.textContent = text;
}

function hide(el) {
  el.style.display = "none";
  el.textContent = "";
}

function goBackToStep1() {
  step1.classList.remove("hidden");
  step2.classList.add("hidden");
  hide(msg1);
}

// Format ID number input
document.getElementById('idn').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length > 13) {
    value = value.substring(0, 13);
  }
  e.target.value = value;
});

sendBtn.addEventListener("click", async () => {
  hide(msg1);
  
  const idn = document.getElementById("idn").value.trim();
  const email = document.getElementById("email").value.trim().toLowerCase();

  // Validation
  if (!idn || !email) {
    return show(msg1, "Please fill in both ID number and email address.", 'error');
  }
  
  if (!/^[0-9]{13}$/.test(idn)) {
    return show(msg1, "Please enter a valid 13-digit South African ID number.", 'error');
  }
  
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return show(msg1, "Please enter a valid email address.", 'error');
  }

  sendBtn.disabled = true;
  sendBtn.textContent = "Checking...";
  
  try {
    // 1. Check if client exists in database
    const { data: clientData, error: clientError } = await client
      .from('edsa_client_database')
      .select('sale_reference, first_name, last_name')
      .eq('client_id_number', idn)
      .eq('email', email)
      .maybeSingle();

    if (clientError) {
      throw new Error('Database error: ' + clientError.message);
    }

    if (!clientData) {
      return show(msg1, 'No client found with this ID number and email combination.', 'error');
    }

    sendBtn.textContent = "Sending link...";

    // 2. Create or get auth user for this client
    const { data: authResult, error: authError } = await client
      .rpc('get_or_create_client_auth', {
        p_id_number: idn,
        p_email: email,
        p_sale_reference: clientData.sale_reference
      });

    if (authError) {
      throw new Error('Auth setup error: ' + authError.message);
    }

    // 3. Send magic link using Supabase's built-in system
    const redirectUrl = `${window.location.origin}/track-portfolio.html?ref=${encodeURIComponent(clientData.sale_reference)}`;
    
    const { error: magicLinkError } = await client.auth.signInWithOtp({
      email: email,
      options: {
        emailRedirectTo: redirectUrl,
        data: {
          client_name: `${clientData.first_name} ${clientData.last_name}`,
          reference: clientData.sale_reference
        }
      }
    });

    if (magicLinkError) {
      throw new Error('Failed to send magic link: ' + magicLinkError.message);
    }

    show(msg1, '‚úÖ Secure login link sent to your email!', 'success');
    
    setTimeout(() => {
      step1.classList.add("hidden");
      step2.classList.remove("hidden");
    }, 1500);
    
  } catch(error) {
    console.error('Error:', error);
    show(msg1, error.message || "Failed to process request. Please try again.", 'error');
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "Send Secure Login Link";
  }
});

console.log('üöÄ Track Application page loaded (using Supabase Auth)');
</script>
</body>
</html>