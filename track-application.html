<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Track Your Application — OTP Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="erase-debt-logo.png"/>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#003865,#005c97);color:#fff;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .wrap{max-width:520px;margin:20px;padding:32px;background:#fff;border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,.3);color:#333}
    .logo{display:block;margin:0 auto 20px;width:100px;border-radius:12px}
    h1{margin:0 0 12px;font-size:28px;text-align:center;color:#2970ba;font-weight:800}
    p.sub{margin:0 0 24px;color:#64748b;text-align:center;line-height:1.5}
    label{display:block;margin:16px 0 8px;color:#374151;font-weight:600}
    input{width:100%;padding:14px 16px;border-radius:12px;border:2px solid #e5e7eb;background:#fff;color:#333;outline:none;font-size:16px;transition:border-color .2s}
    input:focus{border-color:#2970ba;box-shadow:0 0 0 3px rgba(41,112,186,.1)}
    input::placeholder{color:#9ca3af}
    button{margin-top:20px;width:100%;padding:14px 16px;border:0;border-radius:12px;background:#2970ba;color:#fff;font-weight:700;cursor:pointer;font-size:16px;transition:background .2s}
    button:hover{background:#1e40af}
    button:disabled{opacity:.6;cursor:not-allowed;background:#9ca3af}
    .notice{margin-top:16px;padding:12px 16px;border-radius:10px;background:#f0f9ff;color:#1e40af;display:none;border-left:4px solid #2970ba}
    .error{background:#fef2f2;color:#dc2626;border-left-color:#dc2626}
    .success{background:#f0fdf4;color:#16a34a;border-left-color:#16a34a}
    .hidden{display:none}
    .back{display:inline-block;margin-top:24px;color:#2970ba;text-decoration:none;text-align:center;width:100%;font-weight:600}
    .back:hover{text-decoration:underline}
    .step-indicator{display:flex;justify-content:center;margin-bottom:24px;gap:8px}
    .step-dot{width:10px;height:10px;border-radius:50%;background:#e5e7eb}
    .step-dot.active{background:#2970ba}
    .step-dot.completed{background:#16a34a}
  </style>
</head>
<body>
  <div class="wrap">
    <img src="erase-debt-logo.png" alt="Erase Debt SA" class="logo"/>
    <h1>Track Your Application</h1>
    
    <div class="step-indicator">
      <div class="step-dot active" id="dot1"></div>
      <div class="step-dot" id="dot2"></div>
    </div>

    <div id="step1">
      <p class="sub">Enter your ID & email. We'll find your reference and send a one-time password (OTP) to your email.</p>
      
      <label>South African ID Number</label>
      <input id="idn" placeholder="e.g. 8804015196086" inputmode="numeric" autocomplete="off"/>

      <label>Email Address</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email"/>

      <button id="sendBtn">Find & Send OTP</button>
      <div id="msg1" class="notice"></div>
    </div>

    <div id="step2" class="hidden">
      <p class="sub">We've sent a 6-digit verification code to your email address. Please enter it below.</p>
      
      <label>Enter OTP</label>
      <input id="otp" placeholder="6-digit code" inputmode="numeric" autocomplete="one-time-code" maxlength="6"/>
      <button id="verifyBtn">Verify & Continue</button>
      <div id="msg2" class="notice"></div>
      
      <button id="backBtn" style="background:#6b7280;margin-top:12px;">← Go Back</button>
    </div>

    <div style="text-align:center;">
      <a class="back" href="index.html">← Back to Homepage</a>
    </div>
  </div>

<script>
const PROJECT_URL = "https://xzjunkpxvfdpuogoflzh.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ";
const SHARED_TOKEN = "mySuperSecretKey123!@#1234567890qwertyuiioopasdfghjklzxcvbnm09876543210";

let REF_NUMBER = null;

const sendBtn = document.getElementById("sendBtn");
const verifyBtn = document.getElementById("verifyBtn");
const backBtn = document.getElementById("backBtn");
const msg1 = document.getElementById("msg1");
const msg2 = document.getElementById("msg2");
const step1 = document.getElementById("step1");
const step2 = document.getElementById("step2");
const dot1 = document.getElementById("dot1");
const dot2 = document.getElementById("dot2");

function show(el, text, isError = false) {
  el.style.display = "block";
  el.className = "notice" + (isError ? " error" : " success");
  el.textContent = text;
}

function hide(el) { 
  el.style.display = "none"; 
  el.textContent = ""; 
}

function goToStep2() {
  step1.classList.add("hidden");
  step2.classList.remove("hidden");
  dot1.classList.remove("active");
  dot1.classList.add("completed");
  dot2.classList.add("active");
}

function goToStep1() {
  step2.classList.add("hidden");
  step1.classList.remove("hidden");
  dot1.classList.add("active");
  dot1.classList.remove("completed");
  dot2.classList.remove("active");
  hide(msg1);
  hide(msg2);
}

async function lookupRef(idn, email) {
  const resp = await fetch(`${PROJECT_URL}/functions/v1/lookup-ref`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${ANON_KEY}`,
      "x-edsa-token": SHARED_TOKEN
    },
    body: JSON.stringify({ id_number: idn, email })
  });
  
  const data = await resp.json();
  if (!resp.ok || !data?.ok || !data?.ref_number) {
    throw new Error(data?.error || `Lookup failed (HTTP ${resp.status})`);
  }
  return data.ref_number;
}

sendBtn.addEventListener("click", async () => {
  hide(msg1);
  const idn = document.getElementById("idn").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!idn || !email) {
    return show(msg1, "Please fill in both ID and Email.", true);
  }

  // Basic ID validation
  if (!/^\d{13}$/.test(idn)) {
    return show(msg1, "Please enter a valid 13-digit South African ID number.", true);
  }

  // Basic email validation
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return show(msg1, "Please enter a valid email address.", true);
  }

  sendBtn.disabled = true;
  sendBtn.textContent = "Searching...";
  
  try {
    // 1) Find the client's ref number securely
    REF_NUMBER = await lookupRef(idn, email);

    // 2) Send OTP tied to that ref
    const resp = await fetch(`${PROJECT_URL}/functions/v1/send-otp`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${ANON_KEY}`,
        "x-edsa-token": SHARED_TOKEN
      },
      body: JSON.stringify({ ref_number: REF_NUMBER, id_number: idn, email })
    });
    
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      show(msg1, data?.error || `Failed to send OTP (HTTP ${resp.status}).`, true);
      return;
    }
    
    show(msg1, `OTP sent for Ref ${REF_NUMBER}. Please check your email (valid for ${data.expires_in_minutes || 10} minutes).`);
    setTimeout(() => {
      goToStep2();
    }, 2000);
    
  } catch(e) {
    show(msg1, e?.message || "Lookup failed. Please check your details.", true);
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "Find & Send OTP";
  }
});

verifyBtn.addEventListener("click", async () => {
  hide(msg2);
  const idn = document.getElementById("idn").value.trim();
  const email = document.getElementById("email").value.trim();
  const otp = document.getElementById("otp").value.trim();

  if (!otp) {
    return show(msg2, "Enter the OTP from your email.", true);
  }

  if (!/^\d{6}$/.test(otp)) {
    return show(msg2, "Please enter a valid 6-digit OTP.", true);
  }

  if (!REF_NUMBER) {
    return show(msg2, "Reference not found. Please go back and try again.", true);
  }

  verifyBtn.disabled = true;
  verifyBtn.textContent = "Verifying...";
  
  try {
    const resp = await fetch(`${PROJECT_URL}/functions/v1/verify-otp`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${ANON_KEY}`,
        "x-edsa-token": SHARED_TOKEN
      },
      body: JSON.stringify({ ref_number: REF_NUMBER, id_number: idn, email, otp })
    });
    
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      show(msg2, data?.error || `Could not verify OTP (HTTP ${resp.status}).`, true);
      return;
    }
    
    // Redirect to portfolio with the looked-up ref
    window.location.href = `track-portfolio.html?ref=${encodeURIComponent(REF_NUMBER)}`;
    
  } catch(e) {
    show(msg2, e?.message || "Network error.", true);
  } finally {
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verify & Continue";
  }
});

backBtn.addEventListener("click", () => {
  goToStep1();
  document.getElementById("otp").value = "";
});

// Auto-format ID number input
document.getElementById("idn").addEventListener("input", (e) => {
  e.target.value = e.target.value.replace(/\D/g, '').slice(0, 13);
});

// Auto-format OTP input
document.getElementById("otp").addEventListener("input", (e) => {
  e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
});
</script>
</body>
</html>