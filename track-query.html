<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Follow Up on Your Query | Erase Debt SA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="erase-debt-logo.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { 
      background: linear-gradient(135deg,#003865 0,#005c97 80%); 
      font-family: Arial,sans-serif; 
      color:#223; 
      min-height:100vh; 
      margin:0; 
    }
    .container { 
      max-width: 430px; 
      background: #fff; 
      border-radius: 22px; 
      box-shadow: 0 10px 44px #2970ba44; 
      margin: 48px auto 0 auto; 
      padding: 34px 30px 20px 30px;
    }
    .logo { 
      display:block; 
      margin:0 auto 13px auto; 
      width:80px;
    }
    h2 { 
      color: #2970ba; 
      text-align:center; 
      margin-bottom:10px; 
    }
    .instructions { 
      font-size: 0.95rem; 
      color: #444; 
      margin-bottom: 20px; 
      line-height: 1.5; 
      text-align: center; 
    }
    label { 
      font-weight:bold; 
      display:block; 
      margin:11px 0 6px 0;
    }
    input { 
      width:100%; 
      padding:13px; 
      border-radius:8px; 
      border:1px solid #c7d8ef; 
      font-size:1rem; 
      margin-bottom:10px;
    }
    button { 
      background:#2970ba;
      color:#fff;
      border:none;
      border-radius:9px;
      width:100%;
      font-size:1.12rem;
      padding:13px;
      font-weight:bold;
      cursor:pointer; 
      margin-top:6px;
    }
    button:hover { 
      background:#003865; 
    }
    button:disabled {
      background:#ccc;
      cursor:not-allowed;
    }
    .msg { 
      margin:17px 0 0 0; 
      text-align:center; 
      font-weight:bold;
    }
    .error {
      color: #d32f2f;
    }
    .success {
      color: #256029;
    }
    .hidden {
      display: none;
    }
    .step {
      display: block;
    }
    .result-table { 
      width:100%; 
      margin-top:18px; 
      border-collapse:collapse; 
      background:#f7faff; 
      border-radius:10px; 
      overflow:hidden;
    }
    .result-table th, .result-table td { 
      padding:10px 8px; 
      border-bottom:1px solid #dde3ef; 
      text-align:left; 
    }
    .result-table th { 
      background:#e1f0ff; 
      color:#2560a3;
    }
    .result-table tr:last-child td { 
      border-bottom:none;
    }
    @media (max-width:600px) { 
      .container { 
        max-width:97vw;
        padding:18px 2vw 12px 2vw;
      } 
      .logo { 
        width: 56px;
      } 
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <img src="erase-debt-logo.png" alt="Erase Debt SA Logo" class="logo" />
    
    <!-- Step 1: Enter ID and Email -->
    <div id="step1" class="step">
      <h2>Follow Up on Your Query</h2>
      <div class="instructions">
        Enter your <strong>reference number</strong><br> <em>OR</em><br> your <strong>ID number</strong> and <strong>email address</strong>.<br><br>
        If your ID and email match a query, you'll receive a <strong>6-digit OTP via email</strong> to verify your identity and view your update.
      </div>
      <form id="lookupForm">
        <label>Reference Number (if known)</label>
        <input name="ref" type="text" placeholder="EDSA20250720-1234">
        <div style="text-align:center;margin-bottom:9px;font-size:0.97em;color:#888">OR</div>
        <label>ID Number</label>
        <input name="id_number" type="text" required>
        <label>Email Address</label>
        <input name="email" type="email" required>
        <button type="submit" id="lookupBtn">Search Query</button>
        <div class="msg" id="lookupMsg"></div>
      </form>
    </div>

    <!-- Step 2: Enter OTP -->
    <div id="step2" class="step hidden">
      <h2>Enter Verification Code</h2>
      <div class="instructions">
        We've sent a 6-digit verification code to your email address. Please enter it below to view your query.
      </div>
      <form id="otpForm">
        <label>Enter 6-digit OTP</label>
        <input name="otp" type="text" maxlength="6" required placeholder="000000">
        <button type="submit" id="otpBtn">Verify Code</button>
        <div class="msg" id="otpMsg"></div>
      </form>
      <button onclick="goBackToStep1()" style="background:#666; margin-top:10px;">← Go Back</button>
    </div>

    <!-- Step 3: Show Query Results -->
    <div id="step3" class="step hidden">
      <h2>Your Query Details</h2>
      <div id="resultSection"></div>
      <button onclick="goBackToStep1()" style="background:#666; margin-top:15px;">← Search Another Query</button>
    </div>

    <div style="text-align:center;margin-top:22px;">
      <a href="index.html" style="color:#2970ba;font-weight:bold;text-decoration:underline;">&larr; Back to Homepage</a>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://xzjunkpxvfdpuogoflzh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ'
    );

    let currentQuery = null;
    let currentOtpToken = null;

    function showStep(stepNum) {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step' + stepNum).classList.remove('hidden');
    }

    function showMessage(elementId, message, isError = false) {
      const msgEl = document.getElementById(elementId);
      msgEl.textContent = message;
      msgEl.className = 'msg ' + (isError ? 'error' : 'success');
    }

    function clearMessage(elementId) {
      document.getElementById(elementId).textContent = '';
    }

    function goBackToStep1() {
      showStep(1);
      clearMessage('lookupMsg');
      clearMessage('otpMsg');
      document.getElementById('lookupForm').reset();
      document.getElementById('otpForm').reset();
      currentQuery = null;
      currentOtpToken = null;
    }

    // Generate a random OTP
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Send OTP via email (simulate for now)
    async function sendOTP(email, otp, queryRef) {
      try {
        const response = await fetch(`${supabaseClient.supabaseUrl}/functions/v1/send-otp-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseClient.supabaseKey}`,
            'apikey': supabaseClient.supabaseKey
          },
          body: JSON.stringify({
            email: email,
            otp: otp,
            reference: queryRef,
            firstName: currentQuery?.first_name || ''
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error('Failed to send OTP email');
        }
        
        return true;
      } catch (error) {
        console.error('Error sending OTP:', error);
        return false;
      }
    }

    document.getElementById('lookupForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const lookupBtn = document.getElementById('lookupBtn');
      const refNumber = form.ref.value.trim();
      const idNumber = form.id_number.value.trim();
      const email = form.email.value.trim();

      clearMessage('lookupMsg');
      lookupBtn.disabled = true;
      lookupBtn.textContent = 'Searching...';

      try {
        // If reference number is provided, look up directly
        if (refNumber) {
          const { data, error } = await supabaseClient
            .from("QUERIES")
            .select("*")
            .eq("reference_number", refNumber)
            .single();

          if (error || !data) {
            showMessage('lookupMsg', 'No query found with this reference number.', true);
            return;
          }

          currentQuery = data;
          showQueryResult(data);
          showStep(3);
          return;
        }

        // Otherwise, look up by ID and email
        if (!idNumber || !email) {
          showMessage('lookupMsg', 'Please provide either a reference number OR both ID and email.', true);
          return;
        }

        const { data, error } = await supabaseClient
          .from("QUERIES")
          .select("*")
          .eq("id_number", idNumber)
          .eq("email", email)
          .order("created_at", { ascending: false })
          .limit(1)
          .single();

        if (error || !data) {
          showMessage('lookupMsg', 'No query found matching this ID and email combination.', true);
          return;
        }

        currentQuery = data;
        
        // Generate OTP and send to email
        const otp = generateOTP();
        currentOtpToken = otp;
        
        const emailSent = await sendOTP(email, otp, data.reference_number);
        
        if (emailSent) {
          showMessage('lookupMsg', `Verification code sent to ${email}`, false);
          setTimeout(() => {
            showStep(2);
          }, 1500);
        } else {
          showMessage('lookupMsg', 'Failed to send verification code. Please try again.', true);
        }

      } catch (error) {
        console.error('Lookup error:', error);
        showMessage('lookupMsg', 'An error occurred. Please try again.', true);
      } finally {
        lookupBtn.disabled = false;
        lookupBtn.textContent = 'Search Query';
      }
    });

    document.getElementById('otpForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const otpBtn = document.getElementById('otpBtn');
      const enteredOtp = form.otp.value.trim();

      clearMessage('otpMsg');
      otpBtn.disabled = true;
      otpBtn.textContent = 'Verifying...';

      try {
        if (enteredOtp === currentOtpToken) {
          showMessage('otpMsg', 'Code verified! Loading your query...', false);
          setTimeout(() => {
            showQueryResult(currentQuery);
            showStep(3);
          }, 1000);
        } else {
          showMessage('otpMsg', 'Invalid verification code. Please try again.', true);
        }
      } catch (error) {
        console.error('OTP verification error:', error);
        showMessage('otpMsg', 'Verification failed. Please try again.', true);
      } finally {
        otpBtn.disabled = false;
        otpBtn.textContent = 'Verify Code';
      }
    });

    function showQueryResult(query) {
      const resultSection = document.getElementById('resultSection');
      resultSection.innerHTML = `
        <table class="result-table">
          <tr><th>Reference</th><td>${query.reference_number || '—'}</td></tr>
          <tr><th>Name</th><td>${(query.first_name || '') + ' ' + (query.last_name || '')}</td></tr>
          <tr><th>ID Number</th><td>${query.id_number || '—'}</td></tr>
          <tr><th>Email</th><td>${query.email || '—'}</td></tr>
          <tr><th>Query Type</th><td>${query.query_type || '—'}</td></tr>
          <tr><th>Query Details</th><td>${query.query_text || '—'}</td></tr>
          <tr><th>Status</th><td><strong>${query.status || 'PENDING'}</strong></td></tr>
          <tr><th>Responded By</th><td>${query.responded_by || 'Pending response'}</td></tr>
          <tr><th>Admin Response</th><td>${query.response_text || 'No response yet'}</td></tr>
          <tr><th>Date Submitted</th><td>${query.created_at ? new Date(query.created_at).toLocaleString() : '—'}</td></tr>
          <tr><th>Last Updated</th><td>${query.updated_at ? new Date(query.updated_at).toLocaleString() : '—'}</td></tr>
        </table>
      `;
    }
  </script>
</body>
</html>