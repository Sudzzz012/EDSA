<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Track Your Query | Erase Debt SA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="erase-debt-logo.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root{
      --bg1:#004080; --bg2:#0073e6; --panel:#ffffff; --text:#003f7f; --brand:#005cbf;
      --brand-2:#3385ff; --muted:#c9d7ff; --chip:#e6f0ff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg,#003865 0,#005c97 80%); 
      font-family: Arial,sans-serif; 
      color: #fff; 
      min-height: 100vh; 
      margin: 0; 
    }
    
    /* Login Form Styles */
    .login-container { 
      max-width: 540px; 
      background: #fff; 
      border-radius: 22px; 
      box-shadow: 0 10px 44px #2970ba44; 
      margin: 48px auto 0 auto; 
      padding: 34px 30px 20px 30px;
      color: #223;
    }
    .logo { display: block; margin: 0 auto 13px auto; width: 80px; }
    h2 { color: #2970ba; text-align: center; margin-bottom: 10px; }
    .instructions { 
      font-size: 0.95rem; color: #444; margin-bottom: 20px; 
      line-height: 1.5; text-align: center; 
    }
    
    /* Two Search Methods */
    .search-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .search-section.primary {
      background: #f0f9ff;
      border-color: #0ea5e9;
    }
    .search-section h3 {
      color: #2970ba;
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .search-section p {
      color: #64748b;
      font-size: 14px;
      margin: 0 0 15px 0;
    }
    
    label { font-weight: bold; display: block; margin: 11px 0 6px 0; }
    input { 
      width: 100%; padding: 13px; border-radius: 8px; border: 1px solid #c7d8ef; 
      font-size: 1rem; margin-bottom: 10px;
    }
    button { 
      background: #2970ba; color: #fff; border: none; border-radius: 9px; 
      width: 100%; font-size: 1.12rem; padding: 13px; font-weight: bold; 
      cursor: pointer; margin-top: 6px;
    }
    button:hover { background: #003865; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .msg { margin: 17px 0 0 0; text-align: center; font-weight: bold; }
    .error { color: #d32f2f; }
    .success { color: #256029; }
    .hidden { display: none; }
    .step { display: block; }
    .or-divider { 
      text-align: center; margin: 20px 0; color: #888; 
      position: relative; font-size: 0.9em; font-weight: bold;
    }
    .or-divider::before {
      content: ''; position: absolute; top: 50%; left: 0; right: 0; 
      height: 1px; background: #ddd; z-index: 1;
    }
    .or-divider span {
      background: #fff; padding: 0 15px; position: relative; z-index: 2;
    }

    /* Dashboard Styles */
    .dashboard { padding: 24px; max-width: 1400px; margin: 0 auto; }
    .header { 
      background-color: #002f5f; padding: 18px 20px; display: flex; 
      gap: 16px; align-items: center; justify-content: center; flex-wrap: wrap;
    }
    .header img { height: 58px; border-radius: 12px; }
    .header h1 { margin: 0; font-size: 26px; letter-spacing: .3px; }
    .header .ref {
      margin-left: auto; margin-right: auto; background: rgba(255,255,255,.1);
      padding: 8px 12px; border-radius: 10px; color: #dfe9ff; font-size: 14px;
    }
    
    /* Client Details Section */
    .client-details {
      background: var(--panel); 
      color: var(--text); 
      border-radius: 14px; 
      padding: 20px; 
      box-shadow: 0 6px 22px rgba(0,0,0,.15);
      margin-bottom: 20px;
    }
    .client-details h3 {
      margin: 0 0 16px; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      color: var(--brand); 
      font-size: 18px;
    }
    .client-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .client-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid var(--brand);
    }
    .client-item strong {
      display: block;
      color: var(--brand);
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .client-item span {
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
      margin-top: 20px;
    }
    @media (max-width: 900px) { 
      .grid { grid-template-columns: 1fr; } 
    }
    
    .section {
      background: var(--panel); color: var(--text); border-radius: 14px; 
      padding: 20px; box-shadow: 0 6px 22px rgba(0,0,0,.15);
    }
    .section h3 { 
      margin: 0 0 16px; display: flex; align-items: center; gap: 10px; 
      color: var(--brand); font-size: 18px;
    }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #e9eef7; text-align: left; font-size: 14px; }
    th { background-color: var(--chip); font-weight: bold; }
    
    .chip { 
      display: inline-block; padding: 4px 8px; border-radius: 999px; 
      font-size: 12px; background: var(--chip); color: var(--text); 
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    .dot-ok { background: var(--ok); } 
    .dot-warn { background: var(--warn); } 
    .dot-bad { background: var(--bad); }
    
    .feedback-section { margin-top: 20px; }
    textarea, input[type="file"] {
      width: 100%; padding: 10px; margin-top: 10px; border-radius: 10px; 
      border: 1px solid #cfd9ee; font-size: 15px;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; margin-top: 10px;
      padding: 12px 16px; background: var(--brand); color: #fff; 
      text-decoration: none; border-radius: 10px; font-weight: 600; 
      border: 0; cursor: pointer; transition: .25s;
    }
    .btn:hover { background: var(--brand-2); }
    
    .notice { 
      margin-top: 12px; padding: 10px 12px; border-radius: 10px; 
      background: #0b1a33; color: #cfe0ff; display: none; 
    }
    .notice.err { background: #331016; color: #ffd3d8; }
    .notice.success { background: #0d4a1f; color: #c3f0ca; }
    
    .muted { color: #5b78a5; font-size: 13px; }
    .back-link { text-align: center; margin-top: 20px; }
    .back-link a { color: #2970ba; font-weight: bold; text-decoration: underline; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <!-- Login Steps -->
  <div id="loginFlow">
    <div class="login-container">
      <img src="erase-debt-logo.png" alt="Erase Debt SA Logo" class="logo" />
      
      <!-- Step 1: Two Search Methods -->
      <div id="step1" class="step">
        <h2>Track Your Query</h2>
        <div class="instructions">
          Choose one of the methods below to find and view your query details and responses.
        </div>

        <!-- Method 1: Reference Number Search -->
        <div class="search-section primary">
          <h3><i class="fa-solid fa-hashtag"></i> Method 1: Reference Number Search</h3>
          <p>If you have your query reference number, enter it below for instant access:</p>
          <label>Query Reference Number</label>
          <input name="ref" type="text" placeholder="EDSA20250120-1234" id="refInput">
          <button type="button" id="refBtn">Search by Reference</button>
          <div class="msg" id="refMsg"></div>
        </div>

        <div class="or-divider"><span>OR</span></div>

        <!-- Method 2: ID + Email with OTP -->
        <div class="search-section">
          <h3><i class="fa-solid fa-envelope"></i> Method 2: ID + Email Search (OTP Required)</h3>
          <p>If you don't have a reference number, we'll send you a verification code:</p>
          <label>ID Number</label>
          <input name="id_number" type="text" placeholder="8804015196086" id="idInput">
          <label>Email Address</label>
          <input name="email" type="email" placeholder="your@email.com" id="emailInput">
          <button type="button" id="otpBtn">Send OTP & Search</button>
          <div class="msg" id="otpMsg"></div>
        </div>
      </div>

      <!-- Step 2: Enter OTP -->
      <div id="step2" class="step hidden">
        <h2>Enter Verification Code</h2>
        <div class="instructions">
          We've sent a 6-digit verification code to your email address. Please enter it below to view your query and application details.
        </div>
        <label>Enter 6-digit OTP</label>
        <input name="otp" type="text" maxlength="6" required placeholder="123456" id="otpCodeInput">
        <button type="button" id="verifyBtn">Verify & Access</button>
        <div class="msg" id="verifyMsg"></div>
        <button onclick="goBackToStep1()" style="background:#666; margin-top:10px;">‚Üê Try Again</button>
      </div>

      <div class="back-link">
        <a href="index.html">‚Üê Back to Homepage</a>
      </div>
    </div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboardView" class="hidden">
    <header class="header">
      <img src="erase-debt-logo.png" alt="Erase Debt SA">
      <h1>Your Query & Application Dashboard</h1>
      <div id="refChip" class="ref">Ref: ‚Äî</div>
    </header>

    <div class="dashboard">
      <!-- Client Details Section -->
      <div class="client-details">
        <h3><i class="fa-solid fa-user"></i> Client Information</h3>
        <div class="client-grid">
          <div class="client-item">
            <strong>Full Name</strong>
            <span id="fullClientName">‚Äî</span>
          </div>
          <div class="client-item">
            <strong>ID Number</strong>
            <span id="clientIdNumber">‚Äî</span>
          </div>
          <div class="client-item">
            <strong>Email Address</strong>
            <span id="clientEmail">‚Äî</span>
          </div>
          <div class="client-item">
            <strong>Phone Number</strong>
            <span id="clientPhone">‚Äî</span>
          </div>
          <div class="client-item">
            <strong>Reference Number</strong>
            <span id="clientReference">‚Äî</span>
          </div>
          <div class="client-item">
            <strong>Branch</strong>
            <span id="clientBranch">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Query Details Section (PRIMARY) -->
        <div class="section">
          <h3><i class="fa-regular fa-comments"></i> Query Details & Communication</h3>
          <div id="primaryQueryInfo"></div>
          
          <h4 style="margin-top: 20px; color: var(--brand);">All Communication History</h4>
          <table>
            <thead>
              <tr><th>Date</th><th>Type</th><th>Message</th><th>Admin Reply</th><th>Status</th></tr>
            </thead>
            <tbody id="queryHistory">
              <tr><td colspan="5" class="muted">Loading...</td></tr>
            </tbody>
          </table>

          <div class="feedback-section">
            <h4>Add Follow-up Message</h4>
            <textarea id="followupText" rows="3" placeholder="Type your follow-up message or question..."></textarea>
            <button id="submitFollowup" class="btn">
              <i class="fa-solid fa-paper-plane"></i> Send Follow-up
            </button>
            <div id="followupMsg" class="notice"></div>
          </div>
        </div>

        <!-- Application Status Section (SECONDARY) -->
        <div class="section">
          <h3><i class="fa-solid fa-file-contract"></i> Your Application Status</h3>
          <table>
            <tbody id="appTable">
              <tr><th>Client Name</th><td id="clientName">‚Äî</td></tr>
              <tr><th>Service Type</th><td id="serviceType">‚Äî</td></tr>
              <tr><th>Status</th><td id="appStatus">‚Äî</td></tr>
              <tr><th>Branch</th><td id="branch">‚Äî</td></tr>
              <tr><th>Payments Made</th><td id="paymentsMade">‚Äî</td></tr>
              <tr><th>Missed Payments</th><td id="missedPayments">‚Äî</td></tr>
              <tr><th>Monthly Payment</th><td id="monthlyPayment">‚Äî</td></tr>
              <tr><th>Outstanding Balance</th><td id="outstanding">‚Äî</td></tr>
              <tr><th>Next Payment Date</th><td id="nextPayment">‚Äî</td></tr>
            </tbody>
          </table>
          
          <div class="feedback-section">
            <h4>Submit Document / Application Update</h4>
            <textarea id="appFeedbackText" rows="3" placeholder="Payment proof, document, or update message..."></textarea>
            <div class="row">
              <input id="fileInput" type="file" />
              <button id="submitAppFeedback" class="btn">
                <i class="fa-solid fa-upload"></i> Submit
              </button>
            </div>
            <div id="appMsg" class="notice"></div>
          </div>
        </div>
      </div>

      <div class="back-link">
        <a href="index.html">‚Üê Back to Homepage</a> | 
        <a href="#" onclick="logout()">Start Over</a>
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://xzjunkpxvfdpuogoflzh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ'
    );

    let currentQuery = null;
    let currentClient = null;
    let storedOTP = null;
    let otpEmail = null;

    function showStep(stepNum) {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.add('hidden');
      if (stepNum === 1) {
        document.getElementById('step1').classList.remove('hidden');
      } else if (stepNum === 2) {
        document.getElementById('step2').classList.remove('hidden');
      }
    }

    function showDashboard() {
      document.getElementById('loginFlow').classList.add('hidden');
      document.getElementById('dashboardView').classList.remove('hidden');
    }

    function logout() {
      document.getElementById('loginFlow').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      goBackToStep1();
    }

    function showMessage(elementId, message, isError = false) {
      const msgEl = document.getElementById(elementId);
      msgEl.textContent = message;
      msgEl.className = 'msg ' + (isError ? 'error' : 'success');
    }

    function clearMessage(elementId) {
      document.getElementById(elementId).textContent = '';
      document.getElementById(elementId).className = 'msg';
    }

    function goBackToStep1() {
      showStep(1);
      clearMessage('refMsg');
      clearMessage('otpMsg');
      clearMessage('verifyMsg');
      document.getElementById('refInput').value = '';
      document.getElementById('idInput').value = '';
      document.getElementById('emailInput').value = '';
      document.getElementById('otpCodeInput').value = '';
      currentQuery = null;
      currentClient = null;
      storedOTP = null;
      otpEmail = null;
    }

    function show(el, text, type = 'info') {
      el.style.display = "block";
      el.className = "notice " + type;
      el.textContent = text;
    }

    function hide(el) {
      el.style.display = "none";
      el.textContent = "";
    }

    function fmtDate(d) {
      try { return new Date(d).toLocaleString(); } catch { return d || "‚Äî"; }
    }

    function na(x) { 
      return (x === null || x === undefined || x === "") ? "‚Äî" : x; 
    }

    // Generate a random OTP
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Send OTP via Supabase Edge Function
    async function sendOTP(email, otp, queryRef, firstName) {
      try {
        console.log('Sending OTP to:', email, 'OTP:', otp, 'Ref:', queryRef);
        
        const response = await fetch(`https://xzjunkpxvfdpuogoflzh.supabase.co/functions/v1/send-otp-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6anVua3B4dmZkcHVvZ29mbHpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNjMwNzksImV4cCI6MjA2NDczOTA3OX0.bRMANK5hzAKnuFXylVfhtzuU18CsjeJ4wa1UWHvSPNQ`
          },
          body: JSON.stringify({
            email: email,
            otp: otp,
            reference: queryRef || 'Query Lookup',
            firstName: firstName || ''
          })
        });
        
        console.log('OTP Email Response Status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('SendOTP Error Response:', errorText);
          return false;
        }
        
        const result = await response.json();
        console.log('SendOTP Success Response:', result);
        return result.success === true;
      } catch (error) {
        console.error('Error sending OTP:', error);
        return false;
      }
    }

    // Find query by reference number OR by ID + email
    async function findQuery(searchCriteria) {
      console.log('Searching for query with criteria:', searchCriteria);
      
      let query = supabaseClient.from('QUERIES').select('*');
      
      if (searchCriteria.ref) {
        // Search by reference number
        query = query.eq('reference_number', searchCriteria.ref);
      } else if (searchCriteria.id_number && searchCriteria.email) {
        // Search by ID number + email  
        query = query
          .eq('id_number', searchCriteria.id_number)
          .eq('email', searchCriteria.email);
      } else {
        console.log('Invalid search criteria');
        return null;
      }

      const { data, error } = await query.order('created_at', { ascending: false });

      console.log('Query search result - Data:', data, 'Error:', error);

      if (error) {
        console.error('Query search error:', error);
        return null;
      }

      return data && data.length > 0 ? data[0] : null;
    }

    // Load application data for this client
    async function loadApplicationData(idNumber, email) {
      console.log('Loading application data for:', idNumber, email);
      
      const { data, error } = await supabaseClient
        .from('edsa_client_database')
        .select('*')
        .eq('client_id_number', idNumber)
        .eq('email', email)
        .maybeSingle();

      console.log('Application data result - Data:', data, 'Error:', error);

      return error ? null : data;
    }

    // Load all queries for this client
    async function loadAllQueries(idNumber, email) {
      console.log('Loading all queries for:', idNumber, email);
      
      const { data, error } = await supabaseClient
        .from('QUERIES')
        .select('*')
        .eq('id_number', idNumber)
        .eq('email', email)
        .order('created_at', { ascending: false });

      console.log('All queries result - Data:', data, 'Error:', error);

      return error ? [] : (data || []);
    }

    // Display client details in the top section
    function displayClientDetails(queryData, appData = null) {
      console.log('Displaying client details - Query:', queryData, 'App:', appData);
      
      // Use application data if available, otherwise use query data
      const sourceData = appData || queryData;
      
      if (!sourceData) {
        console.log('No client data available');
        return;
      }

      const fullName = appData ? 
        [appData.first_name, appData.last_name].filter(Boolean).join(' ') :
        [queryData.first_name, queryData.last_name].filter(Boolean).join(' ');

      document.getElementById('fullClientName').textContent = na(fullName);
      document.getElementById('clientIdNumber').textContent = na(sourceData.client_id_number || sourceData.id_number);
      document.getElementById('clientEmail').textContent = na(sourceData.email);
      document.getElementById('clientPhone').textContent = na(sourceData.phone || 'Not provided');
      document.getElementById('clientReference').textContent = na(sourceData.sale_reference || sourceData.reference_number);
      document.getElementById('clientBranch').textContent = na(sourceData.branch_name || 'Not specified');

      console.log('Client details updated:', {
        name: fullName,
        id: sourceData.client_id_number || sourceData.id_number,
        email: sourceData.email,
        ref: sourceData.sale_reference || sourceData.reference_number
      });
    }

    // Display query data (PRIMARY FOCUS)
    function displayQueryData(queries, primaryQuery) {
      console.log('Displaying query data. Primary:', primaryQuery, 'All queries:', queries);
      
      const primaryInfo = document.getElementById('primaryQueryInfo');
      const historyBody = document.getElementById('queryHistory');
      
      if (!primaryQuery) {
        primaryInfo.innerHTML = '<p class="muted">No queries found</p>';
        historyBody.innerHTML = '<tr><td colspan="5" class="muted">No queries found</td></tr>';
        return;
      }

      const clientName = [primaryQuery.first_name, primaryQuery.last_name].filter(Boolean).join(' ') || 'Client';
      
      // Show primary query details
      primaryInfo.innerHTML = `
        <table>
          <tr><th>Reference</th><td><strong>${primaryQuery.reference_number || '‚Äî'}</strong></td></tr>
          <tr><th>Query Type</th><td>${primaryQuery.query_type || 'GENERAL'}</td></tr>
          <tr><th>Date Submitted</th><td>${fmtDate(primaryQuery.created_at)}</td></tr>
          <tr><th>Current Status</th><td><strong>${primaryQuery.status || 'PENDING'}</strong></td></tr>
          <tr><th>Your Message</th><td>${primaryQuery.query_text || primaryQuery.client_message || '‚Äî'}</td></tr>
          <tr><th>Admin Response</th><td>${primaryQuery.response_text || primaryQuery.admin_reply || 'Pending response'}</td></tr>
          ${primaryQuery.attachment_url ? `<tr><th>Attachment</th><td><a href="${primaryQuery.attachment_url}" target="_blank">View File</a></td></tr>` : ''}
        </table>
      `;

      // Show all communication history
      if (!queries || queries.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="5" class="muted">No communication history</td></tr>';
        return;
      }

      const rows = queries.map(q => {
        const status = (q.status || 'PENDING').toUpperCase();
        const dotClass = status.includes('RESOLVED') ? 'dot-ok' : 
                        status.includes('PENDING') ? 'dot-warn' : 'dot-bad';
        return `<tr>
          <td>${fmtDate(q.created_at)}</td>
          <td>${q.query_type || 'GENERAL'}</td>
          <td>${q.query_text || q.client_message || '‚Äî'}</td>
          <td>${q.response_text || q.admin_reply || 'Pending response'}</td>
          <td><span class="status-dot ${dotClass}"></span> ${status}</td>
        </tr>`;
      }).join('');
      historyBody.innerHTML = rows;

      // Set reference number in header
      document.getElementById('refChip').textContent = `Ref: ${primaryQuery.reference_number || 'N/A'}`;
    }

    // Display application data (SECONDARY)
    function displayApplicationData(appData) {
      console.log('Displaying application data:', appData);
      
      if (!appData) {
        document.getElementById('appTable').innerHTML = '<tr><td colspan="2" class="muted">No application found - Query-only client</td></tr>';
        return;
      }

      const fullName = [appData.first_name, appData.last_name].filter(Boolean).join(' ');
      const made = parseInt(appData.total_no_payments_made || 0, 10);
      const missed = parseInt(appData.total_no_missed_payments || 0, 10);
      const totalPlan = parseInt(appData.payment_plan_months || 0, 10);
      const remaining = Math.max(0, totalPlan - made);
      const monthly = parseFloat(appData.monthly_payment || 0);
      const outstanding = Math.max(0, Math.round((remaining * monthly + Number.EPSILON) * 100) / 100);

      document.getElementById('clientName').textContent = na(fullName);
      document.getElementById('serviceType').textContent = na(appData.service_type);
      document.getElementById('appStatus').textContent = na(appData.status);
      document.getElementById('branch').textContent = na(appData.branch_name);
      document.getElementById('paymentsMade').textContent = made;
      document.getElementById('missedPayments').textContent = missed;
      document.getElementById('monthlyPayment').textContent = monthly ? `R${monthly.toLocaleString()}` : "‚Äî";
      document.getElementById('outstanding').textContent = monthly ? `R${outstanding.toLocaleString()}` : "‚Äî";
      document.getElementById('nextPayment').textContent = na(appData.salary_date || appData.tracking_date);
    }

    // Submit follow-up to existing query
    async function submitFollowup() {
      const msgEl = document.getElementById('followupMsg');
      hide(msgEl);
      const text = document.getElementById('followupText').value.trim();

      if (!text) {
        return show(msgEl, 'Please enter a message.', 'err');
      }

      if (!currentQuery) {
        return show(msgEl, 'No active query found.', 'err');
      }

      // Insert follow-up into QUERIES table
      const payload = {
        reference_number: currentQuery.reference_number,
        id_number: currentQuery.id_number,
        email: currentQuery.email,
        first_name: currentQuery.first_name,
        last_name: currentQuery.last_name,
        query_type: 'FOLLOW_UP',
        query_text: text,
        status: 'PENDING'
      };

      const { error } = await supabaseClient.from('QUERIES').insert(payload);
      if (error) {
        console.error(error);
        return show(msgEl, 'Could not submit follow-up. Please try again.', 'err');
      }

      show(msgEl, 'Follow-up submitted successfully!', 'success');
      document.getElementById('followupText').value = '';
      
      // Refresh query history
      const queries = await loadAllQueries(currentQuery.id_number, currentQuery.email);
      displayQueryData(queries, currentQuery);
    }

    // Submit application feedback
    async function submitAppFeedback() {
      const msgEl = document.getElementById('appMsg');
      hide(msgEl);
      const text = document.getElementById('appFeedbackText').value.trim();
      const file = document.getElementById('fileInput').files[0];

      if (!text && !file) {
        return show(msgEl, 'Please enter a message or attach a file.', 'err');
      }

      if (!currentQuery) {
        return show(msgEl, 'No query data found.', 'err');
      }

      let fileUrl = null;
      if (file) {
        const path = `${currentQuery.reference_number || 'query'}/${Date.now()}_${file.name}`;
        const { data: up, error: upErr } = await supabaseClient.storage
          .from('edsa-queries').upload(path, file, { upsert: false });
        
        if (upErr) {
          console.error(upErr);
          return show(msgEl, 'Upload failed. Please try again.', 'err');
        }
        
        const { data: pub } = supabaseClient.storage.from('edsa-queries').getPublicUrl(path);
        fileUrl = pub?.publicUrl || null;
      }

      // Insert as application update query
      const payload = {
        reference_number: currentQuery.reference_number,
        id_number: currentQuery.id_number,
        email: currentQuery.email,
        first_name: currentQuery.first_name,
        last_name: currentQuery.last_name,
        query_type: 'APPLICATION_UPDATE',
        query_text: text,
        attachment_url: fileUrl,
        status: 'PENDING'
      };

      const { error } = await supabaseClient.from('QUERIES').insert(payload);
      if (error) {
        console.error(error);
        return show(msgEl, 'Could not submit. Please try again.', 'err');
      }

      show(msgEl, 'Application update submitted successfully!', 'success');
      document.getElementById('appFeedbackText').value = '';
      document.getElementById('fileInput').value = '';
      
      // Refresh query history
      const queries = await loadAllQueries(currentQuery.id_number, currentQuery.email);
      displayQueryData(queries, currentQuery);
    }

    // Method 1: Reference Number Search (Direct Access)
    document.getElementById('refBtn').addEventListener('click', async function() {
      const refNumber = document.getElementById('refInput').value.trim();
      const refBtn = document.getElementById('refBtn');

      clearMessage('refMsg');
      refBtn.disabled = true;
      refBtn.textContent = 'Searching...';

      try {
        if (!refNumber) {
          showMessage('refMsg', 'Please enter a reference number.', true);
          return;
        }

        console.log('Searching by reference:', refNumber);

        // Search for query by reference
        const queryData = await findQuery({ ref: refNumber });

        if (!queryData) {
          showMessage('refMsg', 'No query found with this reference number.', true);
          return;
        }

        console.log('Found query by reference:', queryData);
        currentQuery = queryData;
        
        // Load both query and application data
        const allQueries = await loadAllQueries(queryData.id_number, queryData.email);
        currentClient = await loadApplicationData(queryData.id_number, queryData.email);
        
        showMessage('refMsg', '‚úÖ Query found! Loading your information...', false);
        
        setTimeout(() => {
          displayClientDetails(currentQuery, currentClient);
          displayQueryData(allQueries, currentQuery);
          displayApplicationData(currentClient);
          showDashboard();
        }, 1000);

      } catch (error) {
        console.error('Reference search error:', error);
        showMessage('refMsg', 'An error occurred. Please try again.', true);
      } finally {
        refBtn.disabled = false;
        refBtn.textContent = 'Search by Reference';
      }
    });

    // Method 2: ID + Email Search (Send OTP)
    document.getElementById('otpBtn').addEventListener('click', async function() {
      const idNumber = document.getElementById('idInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const otpBtn = document.getElementById('otpBtn');

      clearMessage('otpMsg');
      otpBtn.disabled = true;
      otpBtn.textContent = 'Searching...';

      try {
        if (!idNumber || !email) {
          showMessage('otpMsg', 'Please enter both ID number and email address.', true);
          return;
        }

        console.log('Searching by ID + email:', idNumber, email);

        // Search for query
        const queryData = await findQuery({ id_number: idNumber, email: email });

        if (!queryData) {
          showMessage('otpMsg', 'No query found. Please check your ID number and email combination.', true);
          return;
        }

        console.log('Found query by ID + email:', queryData);
        currentQuery = queryData;
        
        // Debug: Log the found query data
        console.log('Query found - Reference:', queryData.reference_number, 'Name:', queryData.first_name, queryData.last_name);
        
        // Generate and store OTP
        storedOTP = generateOTP();
        otpEmail = queryData.email;
        
        console.log('Generated OTP:', storedOTP, 'for email:', otpEmail);
        
        otpBtn.textContent = 'Sending OTP...';
        
        // Send OTP email
        const emailSent = await sendOTP(
          queryData.email, 
          storedOTP, 
          queryData.reference_number,
          queryData.first_name
        );
        
        if (emailSent) {
          showMessage('otpMsg', `‚úÖ Verification code sent to ${queryData.email}`, false);
          setTimeout(() => showStep(2), 1500);
        } else {
          console.log('Email send failed, using demo mode');
          showMessage('otpMsg', `Email service issue. Demo Mode: Use OTP ${storedOTP} to continue`, false);
          setTimeout(() => showStep(2), 2000);
        }

      } catch (error) {
        console.error('OTP search error:', error);
        showMessage('otpMsg', `Search error: ${error.message}. Please check your details and try again.`, true);
      } finally {
        otpBtn.disabled = false;
        otpBtn.textContent = 'Send OTP & Search';
      }
    });

    // Step 2: Verify OTP and load data
    document.getElementById('verifyBtn').addEventListener('click', async function() {
      const enteredOtp = document.getElementById('otpCodeInput').value.trim();
      const verifyBtn = document.getElementById('verifyBtn');

      clearMessage('verifyMsg');
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';

      try {
        console.log('Verifying OTP. Entered:', enteredOtp, 'Expected:', storedOTP);
        
        // Verify OTP
        if (enteredOtp === storedOTP) {
          showMessage('verifyMsg', '‚úÖ Verified! Loading your information...', false);
          
          // Load both query and application data
          const allQueries = await loadAllQueries(currentQuery.id_number, currentQuery.email);
          currentClient = await loadApplicationData(currentQuery.id_number, currentQuery.email);
          
          console.log('Loading complete. All queries:', allQueries, 'Client data:', currentClient);
          
          setTimeout(() => {
            displayClientDetails(currentQuery, currentClient);
            displayQueryData(allQueries, currentQuery);
            displayApplicationData(currentClient);
            showDashboard();
          }, 1000);
        } else {
          showMessage('verifyMsg', '‚ùå Invalid verification code. Please try again.', true);
        }
      } catch (error) {
        console.error('OTP verification error:', error);
        showMessage('verifyMsg', 'Verification failed. Please try again.', true);
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify & Access';
      }
    });

    // Event listeners for feedback
    document.getElementById('submitFollowup').addEventListener('click', submitFollowup);
    document.getElementById('submitAppFeedback').addEventListener('click', submitAppFeedback);

    // Auto-format ID input (numbers only, max 13 digits)
    document.getElementById('idInput').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 13) value = value.substring(0, 13);
      e.target.value = value;
      
      // Debug: Log the formatted value
      console.log('ID input formatted to:', value);
      
      // Clear reference field when typing ID
      if (value) {
        document.getElementById('refInput').value = '';
        clearMessage('refMsg');
      }
    });

    // Auto-format OTP input (numbers only, max 6 digits)
    document.getElementById('otpCodeInput').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 6) value = value.substring(0, 6);
      e.target.value = value;
      
      // Auto-submit when 6 digits entered
      if (value.length === 6) {
        setTimeout(() => document.getElementById('verifyBtn').click(), 500);
      }
    });

    // Clear other fields when switching methods
    document.getElementById('refInput').addEventListener('input', function(e) {
      if (e.target.value.trim()) {
        document.getElementById('idInput').value = '';
        document.getElementById('emailInput').value = '';
        clearMessage('otpMsg');
      }
    });

    document.getElementById('emailInput').addEventListener('input', function(e) {
      if (e.target.value.trim()) {
        document.getElementById('refInput').value = '';
        
        // Debug: Log email input
        console.log('Email input:', e.target.value.trim());
        clearMessage('refMsg');
      }
    });

    console.log('üîç Track Query page loaded successfully');
  </script>
</body>
</html>